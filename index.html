<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinguaMax - AI è‹±èªå­¸ç¿’ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-light: #34d399;
            --secondary: #3b82f6;
            --secondary-dark: #2563eb;
            --accent: #8b5cf6;
            --accent-light: #a78bfa;
            --gold: #fbbf24;
            --gold-light: #fcd34d;
            --danger: #ef4444;
            --danger-light: #f87171;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text-light: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.2);
        }

        * { 
            font-family: 'Nunito', sans-serif;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        body > * {
            position: relative;
            z-index: 1;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 8px 32px 0 rgba(0, 0, 0, 0.3),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            background: rgba(30, 41, 59, 0.85);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 12px 40px 0 rgba(0, 0, 0, 0.4),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .glow-green { 
            box-shadow: 
                0 0 20px rgba(16, 185, 129, 0.4),
                0 0 40px rgba(16, 185, 129, 0.2);
        }
        .glow-blue { 
            box-shadow: 
                0 0 20px rgba(59, 130, 246, 0.4),
                0 0 40px rgba(59, 130, 246, 0.2);
        }
        .glow-gold { 
            box-shadow: 
                0 0 20px rgba(251, 191, 36, 0.4),
                0 0 40px rgba(251, 191, 36, 0.2);
        }
        .glow-purple {
            box-shadow: 
                0 0 20px rgba(139, 92, 246, 0.4),
                0 0 40px rgba(139, 92, 246, 0.2);
        }

        /* Flashcard 3D ç¿»è½‰ */
        .flashcard { perspective: 1500px; }
        .flashcard-inner {
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .flashcard-back { transform: rotateY(180deg); }

        /* é€²åº¦æ¢å‹•ç•« */
        .progress-fill {
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 50%, var(--primary) 100%);
            background-size: 200% 100%;
            animation: progress-shine 2s ease-in-out infinite;
            box-shadow: 
                0 0 10px rgba(16, 185, 129, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        @keyframes progress-shine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* æŒ‰éˆ•æ•ˆæœ */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            box-shadow: 
                0 4px 14px 0 rgba(16, 185, 129, 0.4),
                0 2px 4px 0 rgba(0, 0, 0, 0.2),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px 0 rgba(16, 185, 129, 0.5),
                0 4px 6px 0 rgba(0, 0, 0, 0.3),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.25);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 8px 0 rgba(16, 185, 129, 0.3),
                inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
        }

        .btn-option {
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        .btn-option:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-option:hover {
            border-color: var(--secondary);
            background: rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-option.correct {
            border-color: var(--primary) !important;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(16, 185, 129, 0.15)) !important;
            animation: pulse-green 0.5s;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4) !important;
        }
        .btn-option.wrong {
            border-color: var(--danger) !important;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(239, 68, 68, 0.15)) !important;
            animation: shake 0.5s;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4) !important;
        }

        @keyframes pulse-green {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) rotate(-2deg); }
            20%, 40%, 60%, 80% { transform: translateX(8px) rotate(2deg); }
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }

        @keyframes float {
            0%, 100% { 
                transform: translateY(0) rotate(0deg);
            }
            33% { 
                transform: translateY(-10px) rotate(2deg);
            }
            66% { 
                transform: translateY(-5px) rotate(-2deg);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { 
                opacity: 0;
                transform: scale(0.8);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-slide { 
            animation: slideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .animate-float { 
            animation: float 4s ease-in-out infinite;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .animate-scale-in {
            animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
            border: 1px solid rgba(255,255,255,0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .stat-card:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        /* æ¨¡å¼æŒ‰éˆ•æ”¹é€² */
        .mode-btn, .mobile-mode-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .mode-btn::before, .mobile-mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        .mode-btn:hover::before, .mobile-mode-btn:hover::before {
            left: 100%;
        }
        .mode-btn:hover, .mobile-mode-btn:hover {
            transform: translateX(4px) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* XP å‹•ç•« */
        .xp-popup {
            animation: xpFloat 1.5s ease-out forwards;
        }
        @keyframes xpFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* é€£çºŒå¤©æ•¸ç«ç„° */
        .streak-fire {
            animation: fireGlow 1.5s ease-in-out infinite alternate;
        }
        @keyframes fireGlow {
            from { filter: drop-shadow(0 0 5px #ff6b00); }
            to { filter: drop-shadow(0 0 15px #ff9500); }
        }

        /* è½åŠ›æ³¢å½¢ */
        .sound-wave {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 40px;
        }
        .sound-wave span {
            width: 5px;
            background: linear-gradient(180deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            border-radius: 3px;
            animation: wave 1.2s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }
        .sound-wave span:nth-child(1) { animation-delay: 0s; }
        .sound-wave span:nth-child(2) { animation-delay: 0.1s; }
        .sound-wave span:nth-child(3) { animation-delay: 0.2s; }
        .sound-wave span:nth-child(4) { animation-delay: 0.3s; }
        .sound-wave span:nth-child(5) { animation-delay: 0.4s; }
        .sound-wave span:nth-child(1) { animation-delay: 0s; height: 40%; }
        .sound-wave span:nth-child(2) { animation-delay: 0.1s; height: 70%; }
        .sound-wave span:nth-child(3) { animation-delay: 0.2s; height: 100%; }
        .sound-wave span:nth-child(4) { animation-delay: 0.3s; height: 70%; }
        .sound-wave span:nth-child(5) { animation-delay: 0.4s; height: 40%; }

        @keyframes wave {
            0%, 100% { 
                transform: scaleY(0.4);
                opacity: 0.7;
            }
            50% { 
                transform: scaleY(1.2);
                opacity: 1;
            }
        }

        /* è¼¸å…¥æ¡†æ”¹é€² */
        .typing-input, input[type="text"], input[type="password"] {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .typing-input:focus, input[type="text"]:focus, input[type="password"]:focus {
            transform: scale(1.02);
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.2),
                0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* å¡ç‰‡å…§å®¹å‹•ç•« */
        .view-section {
            animation: fadeIn 0.5s ease-out;
        }

        /* å¾½ç« å’Œæ¨™ç±¤æ”¹é€² */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .badge:hover {
            transform: scale(1.05);
        }

        /* æ”¹é€²æ»¾å‹•æ¢ */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢ï¼ˆå¯é¸ï¼Œå¦‚æœéœ€è¦é¡¯ç¤ºï¼‰ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            transition: background 0.2s;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* æ”¹é€²é¸æ“‡æ¡† */
        select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        select:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        select:focus {
            transform: translateY(-2px);
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.2),
                0 6px 16px rgba(0, 0, 0, 0.3);
        }

        /* æ‰“å­—è¼¸å…¥ */
        .typing-input {
            background: transparent;
            border-bottom: 3px solid var(--secondary);
            color: white;
            font-size: 1.5rem;
            text-align: center;
            outline: none;
            caret-color: var(--secondary);
        }

        /* Modal */
        .modal-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0,0,0,0.7);
        }

        /* éš±è— scrollbar ä½†å¯æ»¾å‹• */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ä¸‹æ‹‰é¸å–®ä¿®å¾© - ç¢ºä¿æ–‡å­—å¯è¦‹ */
        select {
            color: white !important;
            background-color: rgba(30, 41, 59, 0.95) !important;
        }
        select option {
            background-color: #1e293b !important;
            color: white !important;
            padding: 12px !important;
        }
        select:focus {
            outline: 2px solid var(--primary);
        }

        /* åˆå­¸è€…å‹å–„ - æ›´å¤§çš„å­—é«”å’Œé–“è· */
        .beginner-friendly {
            font-size: 1.1rem;
            line-height: 1.8;
        }

        /* æç¤ºæ¨™ç±¤ */
        .hint-tag {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* æ–°æ‰‹å¼•å°æ°£æ³¡ */
        .guide-bubble {
            position: relative;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
        }
        .guide-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #8b5cf6;
        }
    </style>
</head>
<body class="text-white overflow-hidden">

    <!-- API Key Modal -->
    <div id="key-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md animate-slide">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-float">
                    <i class="fa-solid fa-robot text-4xl"></i>
                </div>
                <h2 class="text-2xl font-black">æ­¡è¿ä¾†åˆ° LinguaMax</h2>
                <p class="text-gray-400 mt-2">è¼¸å…¥ Gemini API Key é–‹å§‹å­¸ç¿’</p>
            </div>
            <input type="password" id="api-key-input" 
                class="w-full bg-white/10 border border-white/20 rounded-xl p-4 mb-4 text-white placeholder-gray-500 focus:border-green-500 focus:outline-none transition"
                placeholder="AIzaSy...">
            <button onclick="saveApiKey()" class="btn-primary w-full py-4 rounded-xl text-lg font-bold text-white">
                é–‹å§‹å­¸ç¿’ <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div class="h-screen flex flex-col">
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="glass-card border-b border-white/10 px-4 py-3">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3 md:gap-6">
                    <!-- æ‰‹æ©Ÿç‰ˆé¸å–®æŒ‰éˆ• -->
                    <button onclick="toggleMobileMenu()" class="lg:hidden w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-bars text-lg"></i>
            </button>

                    <h1 class="text-lg md:text-xl font-black bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">
                        LinguaMax
                    </h1>
                    
                    <!-- é€£çºŒå¤©æ•¸ -->
                    <div class="hidden sm:flex items-center gap-2 bg-orange-500/20 px-3 py-1 rounded-full">
                        <i class="fa-solid fa-fire streak-fire text-orange-500"></i>
                        <span id="streak-count" class="font-bold text-orange-400">0</span>
        </div>

                    <!-- XP -->
                    <div class="flex items-center gap-2 bg-yellow-500/20 px-3 py-1 rounded-full">
                        <i class="fa-solid fa-star text-yellow-500"></i>
                        <span id="xp-count" class="font-bold text-yellow-400">0 XP</span>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- ç­‰ç´šé¸æ“‡ -->
                    <div class="relative">
                        <label class="text-xs text-gray-400 absolute -top-5 left-0">é›£åº¦ç­‰ç´š</label>
                        <select id="level-select" onchange="onLevelChange()" class="bg-slate-800 border-2 border-slate-600 rounded-xl px-4 py-2.5 text-base font-semibold cursor-pointer hover:border-green-500 transition min-w-[180px]">
                            <option value="A1" selected>ğŸŒ± å…¥é–€ (A1)</option>
                            <option value="A2">ğŸŒ¿ åˆç´š (A2)</option>
                            <option value="B1">ğŸŒ³ ä¸­ç´š (B1)</option>
                            <option value="B2">ğŸŒ² ä¸­é«˜ç´š (B2)</option>
                            <option value="C1">ğŸ”ï¸ é€²éš (C1)</option>
                            <option value="C2">â›°ï¸ ç²¾é€š (C2)</option>
                            <option value="TOEIC">ğŸ“˜ å¤šç›Šå¸¸è€ƒ</option>
                            <option value="IELTS">ğŸ“— é›…æ€å¿…å‚™</option>
                            <option value="TOEFL">ğŸ“™ æ‰˜ç¦å­¸è¡“</option>
                            <option value="GRE">ğŸ“ GRE é«˜ç´š</option>
                            <option value="BUSINESS">ğŸ’¼ å•†æ¥­è‹±èª</option>
                    </select>
                    </div>

                    <!-- å€‹äººè³‡æ–™ -->
                    <button onclick="openStats()" class="w-11 h-11 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold hover:scale-105 transition" title="å­¸ç¿’çµ±è¨ˆ">
                        <i class="fa-solid fa-chart-line text-lg"></i>
                </button>
                </div>
            </div>
        </header>

        <!-- æ‰‹æ©Ÿç‰ˆé¸å–® (è¦†è“‹å±¤) -->
        <div id="mobile-menu" class="fixed inset-0 z-40 hidden lg:hidden">
            <div class="absolute inset-0 bg-black/60" onclick="toggleMobileMenu()"></div>
            <aside class="absolute left-0 top-0 bottom-0 w-72 glass-card border-r border-white/10 p-4 overflow-y-auto hide-scrollbar animate-slide">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-gray-400 flex items-center gap-2">
                        <i class="fa-solid fa-book-open text-green-500"></i> é¸æ“‡å­¸ç¿’æ¨¡å¼
                    </h3>
                    <button onclick="toggleMobileMenu()" class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-times"></i>
                    </button>
            </div>

                <nav class="space-y-2" id="mobile-mode-nav">
                    <button onclick="switchMode('flashcard'); toggleMobileMenu();" data-mode="flashcard" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-green-500/20 border-2 border-green-500 text-green-400">
                        <i class="fa-solid fa-clone text-xl"></i>
                        <div class="text-left">
                            <div class="font-bold">å–®å­—é–ƒå¡</div>
                            <div class="text-xs opacity-60">ç¿»è½‰å­¸ç¿’æ–°å–®å­—</div>
            </div>
                    </button>
                    <button onclick="switchMode('quiz'); toggleMobileMenu();" data-mode="quiz" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-circle-question text-xl text-blue-400"></i>
                        <div class="text-left">
                            <div class="font-bold">é¸æ“‡é¡Œæ¸¬é©—</div>
                            <div class="text-xs opacity-60">å››é¸ä¸€å¿«é€Ÿç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('typing'); toggleMobileMenu();" data-mode="typing" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-keyboard text-xl text-purple-400"></i>
                        <div class="text-left">
                            <div class="font-bold">æ‹¼å¯«ç·´ç¿’</div>
                            <div class="text-xs opacity-60">æ‰“å­—è¨˜æ†¶å–®å­—</div>
                        </div>
                    </button>
                    <button onclick="switchMode('combine'); toggleMobileMenu();" data-mode="combine" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-puzzle-piece text-xl text-indigo-400"></i>
                        <div class="text-left">
                            <div class="font-bold">å–®å­—çµ„åˆ</div>
                            <div class="text-xs opacity-60">çµ„åˆå–®å­—ç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('listening'); toggleMobileMenu();" data-mode="listening" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-headphones text-xl text-cyan-400"></i>
                        <div class="text-left">
                            <div class="font-bold">è½åŠ›è¨“ç·´</div>
                            <div class="text-xs opacity-60">è½éŸ³è¾¨ç¾©ç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('grammar'); toggleMobileMenu();" data-mode="grammar" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-spell-check text-xl text-amber-400"></i>
                        <div class="text-left">
                            <div class="font-bold">æ–‡æ³•é—˜é—œ</div>
                            <div class="text-xs opacity-60">å¥å‹çµæ§‹ç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('chat'); toggleMobileMenu();" data-mode="chat" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-comments text-xl text-rose-400"></i>
                        <div class="text-left">
                            <div class="font-bold">AI å°è©±</div>
                            <div class="text-xs opacity-60">æƒ…å¢ƒè‹±èªæœƒè©±</div>
                        </div>
                    </button>
                </nav>

                <hr class="border-white/10 my-6">

                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-folder text-yellow-500"></i> é¸æ“‡å­¸ç¿’ä¸»é¡Œ
                </h3>
                <select id="mobile-topic-select" onchange="onMobileTopicChange()" 
                    class="w-full bg-slate-800 border-2 border-slate-600 rounded-xl px-4 py-3 text-base font-semibold cursor-pointer hover:border-yellow-500 transition">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </select>
            </aside>
            </div>

        <!-- ä¸»å…§å®¹å€ -->
        <div class="flex-1 flex overflow-hidden">
            <!-- å´é‚Šæ¬„ (æ¡Œé¢ç‰ˆ) -->
            <aside class="w-72 glass-card border-r border-white/10 p-6 hidden lg:block overflow-y-auto hide-scrollbar">
                <h3 class="text-sm font-bold text-gray-400 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-book-open text-green-500"></i> é¸æ“‡å­¸ç¿’æ¨¡å¼
                </h3>
                
                <nav class="space-y-2" id="mode-nav">
                    <button onclick="switchMode('flashcard')" data-mode="flashcard" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-green-500/20 border-2 border-green-500 text-green-400">
                        <i class="fa-solid fa-clone text-xl"></i>
                        <div class="text-left">
                            <div class="font-bold">å–®å­—é–ƒå¡</div>
                            <div class="text-xs opacity-60">ç¿»è½‰å­¸ç¿’æ–°å–®å­—</div>
            </div>
                    </button>

                    <button onclick="switchMode('quiz')" data-mode="quiz" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-circle-question text-xl text-blue-400"></i>
                        <div class="text-left">
                            <div class="font-bold">é¸æ“‡é¡Œæ¸¬é©—</div>
                            <div class="text-xs opacity-60">å››é¸ä¸€å¿«é€Ÿç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('typing')" data-mode="typing" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-keyboard text-xl text-purple-400"></i>
                        <div class="text-left">
                            <div class="font-bold">æ‹¼å¯«ç·´ç¿’</div>
                            <div class="text-xs opacity-60">æ‰“å­—è¨˜æ†¶å–®å­—</div>
                        </div>
                    </button>

                    <button onclick="switchMode('combine')" data-mode="combine" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-puzzle-piece text-xl text-indigo-400"></i>
                        <div class="text-left">
                            <div class="font-bold">å–®å­—çµ„åˆ</div>
                            <div class="text-xs opacity-60">çµ„åˆå–®å­—ç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('listening')" data-mode="listening" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-headphones text-xl text-cyan-400"></i>
                        <div class="text-left">
                            <div class="font-bold">è½åŠ›è¨“ç·´</div>
                            <div class="text-xs opacity-60">è½éŸ³è¾¨ç¾©ç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('grammar')" data-mode="grammar" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-spell-check text-xl text-amber-400"></i>
                        <div class="text-left">
                            <div class="font-bold">æ–‡æ³•é—–é—œ</div>
                            <div class="text-xs opacity-60">å¥å‹çµæ§‹ç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('chat')" data-mode="chat" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-comments text-xl text-rose-400"></i>
                        <div class="text-left">
                            <div class="font-bold">AI å°è©±</div>
                            <div class="text-xs opacity-60">æƒ…å¢ƒè‹±èªæœƒè©±</div>
                        </div>
                    </button>
                </nav>

                <hr class="border-white/10 my-6">

                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-folder text-yellow-500"></i> é¸æ“‡å­¸ç¿’ä¸»é¡Œ
                </h3>
                <select id="topic-select" onchange="onTopicChange()" 
                    class="w-full bg-slate-800 border-2 border-slate-600 rounded-xl px-4 py-3 text-base font-semibold cursor-pointer hover:border-yellow-500 transition">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </select>
                <div id="topic-list" class="hidden">
                    <!-- ä¿ç•™çµ¦èˆŠç‰ˆç›¸å®¹ -->
                </div>

                <hr class="border-white/10 my-6">

                <!-- ä»Šæ—¥é€²åº¦ -->
                <div class="glass-card rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-bold">ä»Šæ—¥ç›®æ¨™</span>
                        <span class="text-xs text-gray-400"><span id="today-learned">0</span>/20 å–®å­—</span>
                    </div>
                    <div class="h-3 bg-white/10 rounded-full overflow-hidden">
                        <div id="daily-progress" class="progress-fill h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </aside>

            <!-- ä¸»å­¸ç¿’å€ -->
            <main class="flex-1 overflow-y-auto hide-scrollbar p-6 md:p-8">
                <div class="max-w-4xl mx-auto">
                    
                    <!-- è¼‰å…¥ä¸­ -->
                    <div id="loading" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-40 flex items-center justify-center">
                        <div class="text-center animate-scale-in">
                            <div class="relative w-20 h-20 mx-auto mb-6">
                                <div class="absolute inset-0 border-4 border-primary/30 rounded-full"></div>
                                <div class="absolute inset-0 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <i class="fa-solid fa-sparkles text-primary text-2xl animate-pulse"></i>
                                </div>
                            </div>
                            <p class="font-bold text-xl bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                                AI æ­£åœ¨ç”Ÿæˆå­¸ç¿’å…§å®¹...
                            </p>
                            <p class="mt-2 text-sm text-text-muted">è«‹ç¨å€™ç‰‡åˆ»</p>
                        </div>
                    </div>

                    <!-- å­¸ç¿’é€²åº¦æ¢ -->
                    <div id="session-progress" class="mb-6 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-400">å­¸ç¿’é€²åº¦</span>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-bold"><span id="current-idx">1</span> / <span id="total-items">5</span></span>
                                <button onclick="regenerateContent()" 
                                    class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full flex items-center gap-1 transition"
                                    title="æ›ä¸€æ‰¹æ–°å–®å­—">
                                    <i class="fa-solid fa-shuffle"></i> æ›ä¸€æ‰¹
                                </button>
                            </div>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div id="session-bar" class="progress-fill h-full rounded-full" style="width: 20%"></div>
                        </div>
                    </div>

                    <!-- é–ƒå¡æ¨¡å¼ -->
                    <div id="view-flashcard" class="view-section">
                        <!-- æ–°æ‰‹æç¤º -->
                        <div id="flashcard-guide" class="guide-bubble mb-6 text-center max-w-md mx-auto">
                            <i class="fa-solid fa-hand-pointer mr-2"></i>
                            <strong>æç¤ºï¼š</strong>é»æ“Šå¡ç‰‡å¯ä»¥ç¿»è½‰æŸ¥çœ‹ä¸­æ–‡æ„æ€ï¼
                            <button onclick="this.parentElement.style.display='none'" class="ml-2 opacity-70 hover:opacity-100">âœ•</button>
                        </div>

                        <div class="flashcard h-80 md:h-[420px] cursor-pointer mx-auto max-w-lg" onclick="flipCard()">
                            <div class="flashcard-inner relative w-full h-full">
                                <!-- æ­£é¢ -->
                                <div class="flashcard-face flashcard-front absolute w-full h-full glass-card rounded-3xl flex flex-col items-center justify-center p-8">
                                    <span id="card-pos" class="text-base px-4 py-1.5 rounded-full bg-blue-500/20 text-blue-400 mb-4 font-semibold"></span>
                                    <h2 id="card-word" class="text-5xl md:text-6xl font-black mb-6 text-center"></h2>
                                    
                                    <!-- èªéŸ³æ’­æ”¾æŒ‰éˆ•çµ„ -->
                                    <div class="flex items-center gap-3 mt-2">
                                        <button onclick="event.stopPropagation(); speakSlow()" 
                                            class="w-14 h-14 bg-amber-500/20 border-2 border-amber-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition" 
                                            title="æ…¢é€Ÿæ’­æ”¾">
                                            <i class="fa-solid fa-volume-low text-amber-400 text-lg"></i>
                                            <span class="text-[10px] text-amber-400 mt-0.5">æ…¢é€Ÿ</span>
                                        </button>
                                        <button onclick="event.stopPropagation(); speakNormal()" 
                                            class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex flex-col items-center justify-center hover:scale-110 transition shadow-lg" 
                                            title="æ­£å¸¸é€Ÿåº¦æ’­æ”¾">
                                            <i class="fa-solid fa-volume-high text-white text-2xl"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); speakWord()" 
                                            class="w-14 h-14 bg-green-500/20 border-2 border-green-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition" 
                                            title="é‡è¤‡æ’­æ”¾å…©æ¬¡">
                                            <i class="fa-solid fa-repeat text-green-400 text-lg"></i>
                                            <span class="text-[10px] text-green-400 mt-0.5">x2</span>
                                        </button>
                                    </div>
                                    
                                    <p class="text-gray-400 mt-6 text-base flex items-center gap-2">
                                        <i class="fa-solid fa-hand-pointer animate-bounce"></i>
                                        é»æ“Šå¡ç‰‡ç¿»è½‰
                                    </p>
                                </div>
                                <!-- èƒŒé¢ -->
                                <div class="flashcard-face flashcard-back absolute w-full h-full glass-card rounded-3xl flex flex-col items-center justify-center p-8 glow-green">
                                    <h3 id="card-mean" class="text-3xl md:text-4xl font-bold text-green-400 mb-6 text-center"></h3>
                                    <div class="bg-white/5 rounded-xl p-4 w-full">
                                        <p class="text-sm text-gray-400 mb-1">ä¾‹å¥ï¼š</p>
                                        <p id="card-example" class="text-center text-gray-200 text-lg italic mb-2"></p>
                                        <p id="card-trans" class="text-center text-gray-400 text-base"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- é–ƒå¡æ§åˆ¶æŒ‰éˆ• - æ›´å¤§æ›´æ¸…æ¥š -->
                        <div class="mt-8 text-center text-gray-400 text-sm mb-3">
                            <i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i>
                            ç¿»è½‰å¡ç‰‡å¾Œï¼Œé¸æ“‡ä½ å°é€™å€‹å–®å­—çš„ç†Ÿæ‚‰ç¨‹åº¦ï¼š
                        </div>
                        <div class="flex justify-center gap-3 md:gap-4">
                            <button onclick="rateCard('hard')" class="flex-1 max-w-[160px] py-4 md:py-5 rounded-2xl bg-red-500/20 border-2 border-red-500/50 text-red-400 font-bold hover:bg-red-500/30 hover:scale-105 transition text-base md:text-lg">
                                <i class="fa-solid fa-rotate-right mr-2"></i>å†å­¸ä¸€æ¬¡
                            </button>
                            <button onclick="rateCard('good')" class="flex-1 max-w-[160px] py-4 md:py-5 rounded-2xl bg-yellow-500/20 border-2 border-yellow-500/50 text-yellow-400 font-bold hover:bg-yellow-500/30 hover:scale-105 transition text-base md:text-lg">
                                <i class="fa-solid fa-check mr-2"></i>æœ‰å°è±¡
                            </button>
                            <button onclick="rateCard('easy')" class="flex-1 max-w-[160px] py-4 md:py-5 rounded-2xl bg-green-500/20 border-2 border-green-500/50 text-green-400 font-bold hover:bg-green-500/30 hover:scale-105 transition text-base md:text-lg">
                                <i class="fa-solid fa-star mr-2"></i>å¾ˆç†Ÿæ‚‰
                            </button>
                        </div>
                    </div>

                    <!-- é¸æ“‡é¡Œæ¨¡å¼ -->
                    <div id="view-quiz" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-6 md:p-8 animate-slide">
                            <div class="text-center mb-8">
                                <div class="inline-block bg-blue-500/20 text-blue-400 px-4 py-2 rounded-full text-sm font-semibold mb-4">
                                    <i class="fa-solid fa-circle-question mr-2"></i>é¸æ“‡é¡Œ
                                </div>
                                <p class="text-gray-400 mb-4 text-base">é€™å€‹è‹±æ–‡å–®å­—æ˜¯ä»€éº¼æ„æ€ï¼Ÿ</p>
                                <h2 id="quiz-word" class="text-4xl md:text-5xl font-black mb-4"></h2>
                                
                                <!-- èªéŸ³æŒ‰éˆ•çµ„ -->
                                <div class="flex items-center justify-center gap-3">
                                    <button onclick="speakSlow()" class="bg-amber-500/20 border border-amber-500/50 px-4 py-2 rounded-full text-amber-400 font-semibold hover:scale-105 transition text-sm">
                                        <i class="fa-solid fa-volume-low mr-1"></i>æ…¢é€Ÿ
                                    </button>
                                    <button onclick="speakNormal()" class="bg-gradient-to-r from-blue-500 to-cyan-500 px-6 py-3 rounded-full text-white font-semibold hover:scale-105 transition">
                                        <i class="fa-solid fa-volume-high mr-2"></i>è½ç™¼éŸ³
                                    </button>
                                    <button onclick="speakWord()" class="bg-green-500/20 border border-green-500/50 px-4 py-2 rounded-full text-green-400 font-semibold hover:scale-105 transition text-sm">
                                        <i class="fa-solid fa-repeat mr-1"></i>x2
                                    </button>
                                </div>
                            </div>
                            <p class="text-center text-gray-400 text-sm mb-4">
                                <i class="fa-solid fa-hand-pointer mr-1"></i>é»é¸ä¸‹æ–¹æ­£ç¢ºç­”æ¡ˆ
                            </p>
                            <div id="quiz-options" class="space-y-3 max-w-lg mx-auto">
                                <!-- é¸é …å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                            <div id="quiz-feedback" class="hidden mt-6 p-5 rounded-2xl text-center text-lg">
                                <!-- å›é¥‹ -->
                            </div>
                        </div>
                    </div>

                    <!-- æ‹¼å¯«æ¨¡å¼ -->
                    <div id="view-typing" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-8 animate-slide">
                            <div class="text-center mb-8">
                                <span class="text-sm text-gray-400 mb-2 block">è«‹æ ¹æ“šä¸­æ–‡æ„æ€æ‹¼å¯«è‹±æ–‡å–®å­—</span>
                                <h2 id="typing-hint" class="text-3xl font-bold text-green-400 mb-2"></h2>
                                <p id="typing-pos" class="text-gray-500"></p>
                            </div>

                            <div class="flex justify-center gap-3 mb-8">
                                <button onclick="speakSlow()" 
                                    class="w-14 h-14 bg-amber-500/20 border-2 border-amber-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                    title="æ…¢é€Ÿæ’­æ”¾">
                                    <i class="fa-solid fa-volume-low text-amber-400"></i>
                                    <span class="text-[9px] text-amber-400">æ…¢é€Ÿ</span>
                                </button>
                                <button onclick="speakNormal()" 
                                    class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg"
                                    title="æ­£å¸¸é€Ÿåº¦">
                                    <i class="fa-solid fa-volume-high text-2xl text-white"></i>
                                </button>
                                <button onclick="speakWord()" 
                                    class="w-14 h-14 bg-green-500/20 border-2 border-green-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                    title="æ’­æ”¾å…©æ¬¡">
                                    <i class="fa-solid fa-repeat text-green-400"></i>
                                    <span class="text-[9px] text-green-400">x2</span>
                                </button>
                            </div>

                            <!-- è¼¸å…¥å€åŸŸ (æ‰“å­— + èªéŸ³) -->
                            <div class="relative max-w-md mx-auto">
                                <input type="text" id="typing-input" 
                                    class="typing-input w-full py-2 pr-14"
                                    placeholder="è¼¸å…¥æˆ–èªªå‡ºè‹±æ–‡..."
                                    autocomplete="off"
                                    onkeypress="if(event.key==='Enter') checkTyping()">
                                <!-- èªéŸ³è¼¸å…¥æŒ‰éˆ• -->
                                <button onclick="startVoiceInput('typing-input')" id="typing-mic-btn"
                                    class="absolute right-0 bottom-1 w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg"
                                    title="é»æ“Šèªªå‡ºç­”æ¡ˆ">
                                    <i class="fa-solid fa-microphone text-xl"></i>
                                </button>
                            </div>
                            <p class="text-center text-gray-500 text-xs mt-2">
                                <i class="fa-solid fa-microphone mr-1"></i>é»æ“Šéº¥å…‹é¢¨å¯ä»¥ç”¨èªªçš„
                            </p>

                            <div id="typing-feedback" class="hidden mt-6 p-4 rounded-xl text-center"></div>

                            <!-- èªéŸ³è¾¨è­˜ç‹€æ…‹ -->
                            <div id="voice-status" class="hidden mt-4 text-center">
                                <div class="inline-flex items-center gap-2 bg-red-500/20 text-red-400 px-4 py-2 rounded-full">
                                    <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                                    <span>æ­£åœ¨è†è½...</span>
                                </div>
                            </div>

                            <button onclick="checkTyping()" class="btn-primary w-full max-w-md mx-auto block mt-6 py-4 rounded-xl font-bold text-lg">
                                ç¢ºèªç­”æ¡ˆ
                            </button>
                        </div>
                    </div>

                    <!-- å–®å­—çµ„åˆæ¨¡å¼ -->
                    <div id="view-combine" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-8 animate-slide">
                            <div class="text-center mb-8">
                                <div class="inline-block bg-indigo-500/20 text-indigo-400 px-4 py-2 rounded-full text-sm font-semibold mb-4">
                                    <i class="fa-solid fa-puzzle-piece mr-2"></i>å–®å­—çµ„åˆ
                                </div>
                                <p class="text-gray-400 mb-4 text-base">å°‡å…©å€‹æœ‰æ„ç¾©çš„å–®å­—çµ„åˆèµ·ä¾†ï¼Œæ‹¼å‡ºå®Œæ•´çš„è¤‡åˆè©</p>
                                <h2 id="combine-hint" class="text-3xl font-bold text-indigo-400 mb-2"></h2>
                                <p id="combine-pos" class="text-gray-500"></p>
                            </div>

                            <div class="flex justify-center gap-3 mb-8">
                                <button onclick="speakSlow()" 
                                    class="w-14 h-14 bg-amber-500/20 border-2 border-amber-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                    title="æ…¢é€Ÿæ’­æ”¾">
                                    <i class="fa-solid fa-volume-low text-amber-400"></i>
                                    <span class="text-[9px] text-amber-400">æ…¢é€Ÿ</span>
                                </button>
                                <button onclick="speakNormal()" 
                                    class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg"
                                    title="æ­£å¸¸é€Ÿåº¦">
                                    <i class="fa-solid fa-volume-high text-2xl text-white"></i>
                                </button>
                                <button onclick="speakWord()" 
                                    class="w-14 h-14 bg-green-500/20 border-2 border-green-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                    title="æ’­æ”¾å…©æ¬¡">
                                    <i class="fa-solid fa-repeat text-green-400"></i>
                                    <span class="text-[9px] text-green-400">x2</span>
                                </button>
                            </div>

                            <!-- å–®å­—çµ„åˆå€åŸŸ -->
                            <div class="max-w-2xl mx-auto">
                                <div class="text-center mb-6">
                                    <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-6">
                                        <!-- ç¬¬ä¸€éƒ¨åˆ† -->
                                        <div class="flex flex-col items-center">
                                            <span id="combine-part1" class="bg-indigo-500/20 px-6 py-4 rounded-xl border-2 border-indigo-500/50 text-indigo-300 text-3xl md:text-4xl font-black mb-2"></span>
                                            <span id="combine-part1-mean" class="text-sm text-indigo-400 font-semibold"></span>
                                        </div>
                                        <span class="text-indigo-400 text-3xl font-black">+</span>
                                        <!-- ç¬¬äºŒéƒ¨åˆ† -->
                                        <div class="flex flex-col items-center">
                                            <span id="combine-part2" class="bg-purple-500/20 px-6 py-4 rounded-xl border-2 border-purple-500/50 text-purple-300 text-3xl md:text-4xl font-black mb-2"></span>
                                            <span id="combine-part2-mean" class="text-sm text-purple-400 font-semibold"></span>
                                        </div>
                                        <span class="text-gray-400 text-3xl font-black mx-2">=</span>
                                        <!-- çµæœ -->
                                        <div class="flex flex-col items-center">
                                            <span id="combine-result" class="bg-white/10 px-6 py-4 rounded-xl border-2 border-dashed border-white/30 text-white text-3xl md:text-4xl font-black min-w-[180px]">?</span>
                                        </div>
                                    </div>
                                </div>

                                <p class="text-center text-gray-500 text-sm mb-6">
                                    <i class="fa-solid fa-hand-pointer mr-1"></i>åœ¨ä¸‹æ–¹è¼¸å…¥æ¡†ä¸­è¼¸å…¥å®Œæ•´å–®å­—
                                </p>

                                <!-- è¼¸å…¥å€åŸŸ -->
                                <div class="relative max-w-md mx-auto mb-6">
                                    <input type="text" id="combine-input" 
                                        class="typing-input w-full py-4 text-center text-2xl font-bold"
                                        placeholder="è¼¸å…¥å®Œæ•´å–®å­—..."
                                        autocomplete="off"
                                        onkeypress="if(event.key==='Enter') checkCombine()">
                                </div>

                                <div id="combine-feedback" class="hidden mt-6 p-4 rounded-xl text-center"></div>

                                <button onclick="checkCombine()" class="btn-primary w-full max-w-md mx-auto block mt-6 py-4 rounded-xl font-bold text-lg">
                                    ç¢ºèªç­”æ¡ˆ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- è½åŠ›æ¨¡å¼ -->
                    <div id="view-listening" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-8 animate-slide">
                            <div class="text-center mb-8">
                                <span class="text-sm text-gray-400 mb-4 block">ä»”ç´°è†è½ï¼Œé¸å‡ºä½ è½åˆ°çš„å–®å­—</span>
                                
                                <div class="flex items-center justify-center gap-4">
                                    <!-- æ…¢é€Ÿæ’­æ”¾ -->
                                    <button onclick="replayListeningSlow()" 
                                        class="w-16 h-16 bg-amber-500/20 border-2 border-amber-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                        title="è¶…æ…¢é€Ÿæ’­æ”¾">
                                        <i class="fa-solid fa-volume-low text-amber-400 text-xl"></i>
                                        <span class="text-[10px] text-amber-400">æ…¢é€Ÿ</span>
                                    </button>
                                    
                                    <!-- ä¸»æ’­æ”¾æŒ‰éˆ• -->
                                    <button onclick="playListeningWord()" class="w-24 h-24 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex flex-col items-center justify-center glow-blue hover:scale-105 transition">
                                        <i class="fa-solid fa-play text-4xl"></i>
                                        <span class="text-xs mt-1">æ’­æ”¾</span>
                                    </button>
                                    
                                    <!-- é‡è¤‡æ’­æ”¾ -->
                                    <button onclick="playListeningWord(); setTimeout(playListeningWord, 1500);" 
                                        class="w-16 h-16 bg-green-500/20 border-2 border-green-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                        title="æ’­æ”¾å…©æ¬¡">
                                        <i class="fa-solid fa-repeat text-green-400 text-xl"></i>
                                        <span class="text-[10px] text-green-400">x2</span>
                                    </button>
                                </div>

                                <div class="sound-wave justify-center mt-4 hidden" id="sound-waves">
                                    <span></span><span></span><span></span><span></span><span></span>
                                </div>
                                
                                <p class="text-gray-500 text-xs mt-3">
                                    <i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i>
                                    è½ä¸æ¸…æ¥šï¼Ÿé»ã€Œæ…¢é€Ÿã€æŒ‰éˆ•
                                </p>
                            </div>

                            <div id="listening-options" class="grid grid-cols-2 gap-4">
                                <!-- é¸é … -->
                            </div>

                            <div id="listening-feedback" class="hidden mt-6 p-4 rounded-xl text-center"></div>
                        </div>
                    </div>

                    <!-- æ–‡æ³•æ¨¡å¼ -->
                    <div id="view-grammar" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-8 animate-slide">
                            <div class="mb-6">
                                <span class="px-3 py-1 bg-amber-500/20 text-amber-400 rounded-full text-sm font-bold">
                                    <i class="fa-solid fa-lightbulb mr-1"></i> æ–‡æ³•é‡é»
                                </span>
                                <h3 id="grammar-concept" class="text-2xl font-bold mt-3"></h3>
                                <p id="grammar-explanation" class="text-gray-400 mt-2"></p>
                            </div>

                            <div id="grammar-quiz" class="space-y-6">
                                <!-- æ–‡æ³•é¡Œç›® -->
                            </div>
                        </div>
                    </div>

                    <!-- AI å°è©±æ¨¡å¼ -->
            <div id="view-chat" class="view-section hidden h-full flex flex-col">
                        <div class="glass-card rounded-3xl flex-1 flex flex-col overflow-hidden">
                            <!-- å°è©±æƒ…å¢ƒ -->
                            <div class="p-4 border-b border-white/10 bg-gradient-to-r from-rose-500/20 to-purple-500/20">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center">
                                        <i class="fa-solid fa-user-tie text-xl"></i>
                </div>
                                    <div>
                                        <h3 id="chat-scenario" class="font-bold">æƒ…å¢ƒå°è©±</h3>
                                        <p class="text-xs text-gray-400">AI è‹±èªæ•™ç·´</p>
            </div>
                                </div>
                            </div>

                            <!-- å°è©±å€ -->
                            <div id="chat-messages" class="flex-1 overflow-y-auto hide-scrollbar p-4 space-y-4">
                                <!-- è¨Šæ¯ -->
                            </div>

                            <!-- è¼¸å…¥å€ -->
                            <div class="p-4 border-t border-white/10">
                                <div class="flex gap-2">
                                    <!-- æ™ºèƒ½èªéŸ³è¼¸å…¥æŒ‰éˆ•ï¼ˆè‡ªå‹•åˆ¤æ–·ä¸­è‹±æ–‡ï¼‰ -->
                                    <button onclick="startSmartVoiceInput('chat-input')" id="chat-mic-btn"
                                        class="w-12 h-12 bg-gradient-to-br from-purple-500 via-pink-500 to-orange-500 rounded-full flex items-center justify-center hover:scale-110 transition shrink-0"
                                        title="é»æ“Šèªªè©±ï¼Œè‡ªå‹•è­˜åˆ¥ä¸­è‹±æ–‡">
                                        <i class="fa-solid fa-microphone text-lg"></i>
                                    </button>
                                    <input type="text" id="chat-input" 
                                        class="flex-1 bg-white/10 border border-white/20 rounded-full px-5 py-3 focus:border-rose-500 focus:outline-none transition text-base"
                                        placeholder="èªªä¸­æ–‡æˆ–è‹±æ–‡ï¼Œæˆ–ç›´æ¥æ‰“å­—..."
                                        onkeypress="if(event.key==='Enter') sendChat()">
                                    <button onclick="sendChat()" class="w-12 h-12 bg-gradient-to-r from-rose-500 to-purple-500 rounded-full flex items-center justify-center hover:opacity-90 hover:scale-105 transition shrink-0" title="ç™¼é€">
                                        <i class="fa-solid fa-paper-plane"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2 text-center">
                                    <i class="fa-solid fa-microphone text-purple-400 mr-1"></i>é»éº¥å…‹é¢¨èªªè©±ï¼Œè‡ªå‹•è­˜åˆ¥ä¸­è‹±æ–‡ Â· 
                                    <i class="fa-solid fa-keyboard text-gray-400 mr-1"></i>æˆ–ç›´æ¥æ‰“å­—
                                </p>
                                <!-- èªéŸ³è¾¨è­˜ç‹€æ…‹ -->
                                <div id="chat-voice-status" class="hidden mt-2 text-center">
                                    <div class="inline-flex items-center gap-2 bg-purple-500/20 text-purple-400 px-4 py-2 rounded-full text-sm">
                                        <span class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></span>
                                        <span id="voice-status-text">æ­£åœ¨è†è½...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

        </div>
    </main>
        </div>
    </div>

    <!-- çµ±è¨ˆ Modal -->
    <div id="stats-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto hide-scrollbar animate-slide">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">ğŸ“Š å­¸ç¿’çµ±è¨ˆ</h2>
                <button onclick="closeStats()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-fire text-3xl text-orange-500 mb-2"></i>
                    <div class="text-2xl font-bold" id="stat-streak">0</div>
                    <div class="text-xs text-gray-400">é€£çºŒå¤©æ•¸</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-star text-3xl text-yellow-500 mb-2"></i>
                    <div class="text-2xl font-bold" id="stat-xp">0</div>
                    <div class="text-xs text-gray-400">ç¸½ XP</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-book text-3xl text-green-500 mb-2"></i>
                    <div class="text-2xl font-bold" id="stat-words">0</div>
                    <div class="text-xs text-gray-400">å·²å­¸å–®å­—</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-bullseye text-3xl text-blue-500 mb-2"></i>
                    <div class="text-2xl font-bold" id="stat-accuracy">0%</div>
                    <div class="text-xs text-gray-400">æ­£ç¢ºç‡</div>
                </div>
            </div>

            <!-- å·²å­¸å–®å­—åˆ—è¡¨ -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-sm text-gray-400">
                        <i class="fa-solid fa-list mr-1"></i> å·²å­¸å–®å­—è¨˜éŒ„
                    </h3>
                    <button onclick="toggleLearnedWords()" class="text-xs text-blue-400 hover:text-blue-300">
                        <span id="toggle-words-text">å±•é–‹</span> <i class="fa-solid fa-chevron-down" id="toggle-words-icon"></i>
                    </button>
                </div>
                <div id="learned-words-list" class="hidden bg-white/5 rounded-xl p-4 max-h-48 overflow-y-auto hide-scrollbar">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <div class="space-y-2">
                <button onclick="clearLearnedHistory()" class="w-full py-3 rounded-xl bg-amber-500/20 text-amber-400 font-bold hover:bg-amber-500/30 transition">
                    <i class="fa-solid fa-eraser mr-2"></i>æ¸…é™¤å­¸ç¿’è¨˜éŒ„ï¼ˆå¯é‡æ–°å­¸ç¿’ï¼‰
                </button>
                <button onclick="resetAllData()" class="w-full py-3 rounded-xl bg-red-500/20 text-red-400 font-bold hover:bg-red-500/30 transition">
                    <i class="fa-solid fa-trash-can mr-2"></i>é‡ç½®æ‰€æœ‰æ•¸æ“š
                </button>
            </div>
        </div>
    </div>

    <!-- å®Œæˆå‹•ç•« Modal -->
    <div id="complete-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="text-center animate-slide">
            <div class="text-8xl mb-4">ğŸ‰</div>
            <h2 class="text-3xl font-black mb-2">å¤ªæ£’äº†ï¼</h2>
            <p class="text-gray-400 mb-4">ä½ å®Œæˆäº†é€™ä¸€è¼ªå­¸ç¿’</p>
            <div class="text-5xl font-black text-green-400 mb-6">+<span id="earned-xp">50</span> XP</div>
            <button onclick="continuelearning()" class="btn-primary px-8 py-4 rounded-xl text-lg font-bold">
                ç¹¼çºŒå­¸ç¿’ <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- éŸ³æ•ˆ -->
    <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
    <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3" preload="auto"></audio>

    <script>
        // ===== å…¨åŸŸç‹€æ…‹ =====
        const APP_STATE = {
            currentMode: 'flashcard',
            currentTopic: 'Daily Life',  // å‚³çµ¦ API çš„è‹±æ–‡å€¼
            currentIndex: 0,
            words: [],
            historyData: [],
            isFlipped: false,
            isAnswered: false,
            totalCorrect: 0,
            totalAnswered: 0
        };

        // ä¸»é¡Œè¨­å®š - label é¡¯ç¤ºä¸­æ–‡, value å‚³çµ¦ API
        const TOPICS = {
            flashcard: [
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily Life' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel' },
                { label: 'ğŸ” ç¾é£Ÿé¤é£²', value: 'Food & Drink' },
                { label: 'ğŸ’¼ å•†å‹™è·å ´', value: 'Business' },
                { label: 'ğŸ¥ å¥åº·é†«ç™‚', value: 'Health' },
                { label: 'ğŸ’» ç§‘æŠ€æ•¸ä½', value: 'Technology' },
                { label: 'ğŸ¬ ä¼‘é–’å¨›æ¨‚', value: 'Entertainment' },
                { label: 'ğŸ“ æ ¡åœ’å­¸ç¿’', value: 'School & Education' },
                { label: 'ğŸ‹ï¸ é‹å‹•å¥èº«', value: 'Sports & Fitness' },
                { label: 'ğŸ¨ è—è¡“æ–‡åŒ–', value: 'Art & Culture' },
                { label: 'ğŸŒ ç’°å¢ƒè‡ªç„¶', value: 'Environment & Nature' },
                { label: 'ğŸ‘” æ™‚å°šç©¿æ­', value: 'Fashion & Clothing' },
                { label: 'ğŸ¡ å±…å®¶ç”Ÿæ´»', value: 'Home & Living' },
                { label: 'ğŸ’° é‡‘èç†è²¡', value: 'Finance & Banking' },
                { label: 'âš–ï¸ æ³•å¾‹æ”¿æ²»', value: 'Law & Politics' },
                { label: 'ğŸ”¬ ç§‘å­¸ç ”ç©¶', value: 'Science & Research' },
                { label: 'ğŸ® éŠæˆ²é›»ç«¶', value: 'Gaming & Esports' },
                { label: 'ğŸ“± ç¤¾ç¾¤åª’é«”', value: 'Social Media' },
                { label: 'ğŸš— äº¤é€šé‹è¼¸', value: 'Transportation' },
                { label: 'ğŸ˜Š æƒ…ç·’å¿ƒç†', value: 'Emotions & Psychology' }
            ],
            quiz: [
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily Life' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel' },
                { label: 'ğŸ” ç¾é£Ÿé¤é£²', value: 'Food & Drink' },
                { label: 'ğŸ’¼ å•†å‹™è·å ´', value: 'Business' },
                { label: 'ğŸ¥ å¥åº·é†«ç™‚', value: 'Health' },
                { label: 'ğŸ’» ç§‘æŠ€æ•¸ä½', value: 'Technology' },
                { label: 'ğŸ¬ ä¼‘é–’å¨›æ¨‚', value: 'Entertainment' },
                { label: 'ğŸ“ æ ¡åœ’å­¸ç¿’', value: 'School & Education' },
                { label: 'ğŸ‹ï¸ é‹å‹•å¥èº«', value: 'Sports & Fitness' },
                { label: 'ğŸ¨ è—è¡“æ–‡åŒ–', value: 'Art & Culture' },
                { label: 'ğŸŒ ç’°å¢ƒè‡ªç„¶', value: 'Environment & Nature' },
                { label: 'ğŸ‘” æ™‚å°šç©¿æ­', value: 'Fashion & Clothing' },
                { label: 'ğŸ¡ å±…å®¶ç”Ÿæ´»', value: 'Home & Living' },
                { label: 'ğŸ’° é‡‘èç†è²¡', value: 'Finance & Banking' },
                { label: 'ğŸ”¬ ç§‘å­¸ç ”ç©¶', value: 'Science & Research' },
                { label: 'ğŸ® éŠæˆ²é›»ç«¶', value: 'Gaming & Esports' },
                { label: 'ğŸ˜Š æƒ…ç·’å¿ƒç†', value: 'Emotions & Psychology' }
            ],
            typing: [
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily Life' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel' },
                { label: 'ğŸ” ç¾é£Ÿé¤é£²', value: 'Food & Drink' },
                { label: 'ğŸ’¼ å•†å‹™è·å ´', value: 'Business' },
                { label: 'ğŸ¥ å¥åº·é†«ç™‚', value: 'Health' },
                { label: 'ğŸ’» ç§‘æŠ€æ•¸ä½', value: 'Technology' },
                { label: 'ğŸ“ æ ¡åœ’å­¸ç¿’', value: 'School & Education' },
                { label: 'ğŸ‹ï¸ é‹å‹•å¥èº«', value: 'Sports & Fitness' },
                { label: 'ğŸ¡ å±…å®¶ç”Ÿæ´»', value: 'Home & Living' },
                { label: 'ğŸ˜Š æƒ…ç·’å¿ƒç†', value: 'Emotions & Psychology' }
            ],
            combine: [
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily Life' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel' },
                { label: 'ğŸ” ç¾é£Ÿé¤é£²', value: 'Food & Drink' },
                { label: 'ğŸ’¼ å•†å‹™è·å ´', value: 'Business' },
                { label: 'ğŸ¥ å¥åº·é†«ç™‚', value: 'Health' },
                { label: 'ğŸ’» ç§‘æŠ€æ•¸ä½', value: 'Technology' },
                { label: 'ğŸ“ æ ¡åœ’å­¸ç¿’', value: 'School & Education' },
                { label: 'ğŸ‹ï¸ é‹å‹•å¥èº«', value: 'Sports & Fitness' },
                { label: 'ğŸ¡ å±…å®¶ç”Ÿæ´»', value: 'Home & Living' },
                { label: 'ğŸ˜Š æƒ…ç·’å¿ƒç†', value: 'Emotions & Psychology' }
            ],
            listening: [
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily Life' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel' },
                { label: 'ğŸ” ç¾é£Ÿé¤é£²', value: 'Food & Drink' },
                { label: 'ğŸ›’ è³¼ç‰©æ¶ˆè²»', value: 'Shopping' },
                { label: 'ğŸŒ¤ï¸ å¤©æ°£æ°£å€™', value: 'Weather' },
                { label: 'ğŸ’¼ å•†å‹™è·å ´', value: 'Business' },
                { label: 'ğŸ¥ å¥åº·é†«ç™‚', value: 'Health' },
                { label: 'ğŸ“ æ ¡åœ’å­¸ç¿’', value: 'School & Education' },
                { label: 'ğŸš— äº¤é€šé‹è¼¸', value: 'Transportation' }
            ],
            grammar: [
                { label: 'ğŸ“— ç¾åœ¨å¼', value: 'Present Tense' },
                { label: 'ğŸ“˜ éå»å¼', value: 'Past Tense' },
                { label: 'ğŸ“™ æœªä¾†å¼', value: 'Future Tense' },
                { label: 'ğŸ“• è¢«å‹•èªæ…‹', value: 'Passive Voice' },
                { label: 'ğŸ““ æ¢ä»¶å¥', value: 'Conditionals' },
                { label: 'ğŸ“’ æƒ…æ…‹å‹•è©', value: 'Modals' },
                { label: 'ğŸ“” å®Œæˆå¼', value: 'Perfect Tense' },
                { label: 'ğŸ“š é—œä¿‚å­å¥', value: 'Relative Clauses' },
                { label: 'ğŸ“– æ¯”è¼ƒç´šæœ€é«˜ç´š', value: 'Comparatives & Superlatives' },
                { label: 'ğŸ“ ä»‹ç³»è©', value: 'Prepositions' },
                { label: 'ğŸ“‹ å† è©ç”¨æ³•', value: 'Articles' },
                { label: 'ğŸ“‘ é€£æ¥è©', value: 'Conjunctions' }
            ],
            chat: [
                { label: 'â˜• å’–å•¡å»³é»é¤', value: 'Coffee Shop' },
                { label: 'ğŸ’¼ æ±‚è·é¢è©¦', value: 'Job Interview' },
                { label: 'ğŸ›« æ©Ÿå ´é€šé—œ', value: 'Airport' },
                { label: 'ğŸ¨ é£¯åº—å…¥ä½', value: 'Hotel Check-in' },
                { label: 'ğŸ½ï¸ é¤å»³ç”¨é¤', value: 'Restaurant' },
                { label: 'ğŸ¥ çœ‹é†«ç”Ÿ', value: 'Doctor Visit' },
                { label: 'ğŸ›’ è¶…å¸‚è³¼ç‰©', value: 'Supermarket Shopping' },
                { label: 'ğŸš• æ­è¨ˆç¨‹è»Š', value: 'Taking a Taxi' },
                { label: 'ğŸ“ é›»è©±å®¢æœ', value: 'Customer Service Call' },
                { label: 'ğŸ¦ éŠ€è¡Œé–‹æˆ¶', value: 'Bank Account' },
                { label: 'ğŸ“® éƒµå±€å¯„ä»¶', value: 'Post Office' },
                { label: 'ğŸ« å”®ç¥¨è³¼ç¥¨', value: 'Buying Tickets' },
                { label: 'ğŸ  ç§Ÿæˆ¿çœ‹æˆ¿', value: 'Renting Apartment' },
                { label: 'ğŸ‘‹ èªè­˜æ–°æœ‹å‹', value: 'Meeting New People' },
                { label: 'ğŸ‰ æ´¾å°ç¤¾äº¤', value: 'Party & Social' },
                { label: 'ğŸ“± ç§‘æŠ€å•é¡Œæ±‚åŠ©', value: 'Tech Support' },
                { label: 'ğŸ‹ï¸ å¥èº«æˆ¿è«®è©¢', value: 'Gym Consultation' },
                { label: 'ğŸ’‡ ç¾é«®æ²™é¾', value: 'Hair Salon' }
            ]
        };

        let apiKey = localStorage.getItem('gemini_api_key');
        let userData = JSON.parse(localStorage.getItem('linguamax_user') || '{}');

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', () => {
            if (!apiKey) {
                document.getElementById('key-modal').classList.remove('hidden');
            } else {
                document.getElementById('key-modal').classList.add('hidden');
                initApp();
            }
        });

        function saveApiKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if (val) {
                apiKey = val;
                localStorage.setItem('gemini_api_key', apiKey);
                document.getElementById('key-modal').classList.add('hidden');
                initApp();
            }
        }

        function initApp() {
            loadUserData();
            updateTopics();
            loadContent();
            checkStreak();
        }

        // ===== ç”¨æˆ¶æ•¸æ“š =====
        function loadUserData() {
            if (!userData.xp) {
                userData = { 
                    xp: 0, 
                    streak: 0, 
                    wordsLearned: [],      // å­¸éçš„å–®å­—åˆ—è¡¨
                    learnedHistory: {},    // æŒ‰ä¸»é¡Œåˆ†é¡çš„å­¸ç¿’è¨˜éŒ„
                    totalCorrect: 0, 
                    totalAnswered: 0, 
                    lastActive: null 
                };
            }
            // å…¼å®¹èˆŠç‰ˆæœ¬
            if (!userData.learnedHistory) userData.learnedHistory = {};
            
            updateUI();
        }

        function saveUserData() {
            localStorage.setItem('linguamax_user', JSON.stringify(userData));
            updateUI();
        }

        // å–å¾—æŸä¸»é¡Œå·²å­¸éçš„å–®å­—
        function getLearnedWordsForTopic(topic) {
            return userData.learnedHistory[topic] || [];
        }

        // å„²å­˜å­¸éçš„å–®å­—åˆ°è¨˜éŒ„
        function saveLearnedWord(word, topic) {
            if (!userData.learnedHistory[topic]) {
                userData.learnedHistory[topic] = [];
            }
            if (!userData.learnedHistory[topic].includes(word)) {
                userData.learnedHistory[topic].push(word);
            }
            if (!userData.wordsLearned.includes(word)) {
                userData.wordsLearned.push(word);
            }
            saveUserData();
        }

        function updateUI() {
            document.getElementById('xp-count').textContent = userData.xp + ' XP';
            document.getElementById('streak-count').textContent = userData.streak;
            document.getElementById('today-learned').textContent = Math.min(userData.wordsLearned?.length || 0, 20);
            document.getElementById('daily-progress').style.width = Math.min((userData.wordsLearned?.length || 0) / 20 * 100, 100) + '%';
        }

        function checkStreak() {
            const today = new Date().toDateString();
            const lastActive = userData.lastActive;
            
            if (lastActive) {
                const lastDate = new Date(lastActive);
                const daysDiff = Math.floor((new Date(today) - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 1) {
                    userData.streak = 0; // æ–·é€£
                }
            }
        }

        function addXP(amount) {
            userData.xp += amount;
            userData.lastActive = new Date().toDateString();
            
            // æ›´æ–°é€£çºŒå¤©æ•¸
            const today = new Date().toDateString();
            if (userData.lastActive !== today) {
                userData.streak++;
            }
            
            saveUserData();
            showXPPopup(amount);
        }

        function showXPPopup(amount) {
            const popup = document.createElement('div');
            popup.className = 'xp-popup fixed top-20 left-1/2 -translate-x-1/2 text-2xl font-bold text-yellow-400 z-50';
            popup.textContent = `+${amount} XP`;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1500);
        }

        // ===== æ¨¡å¼åˆ‡æ› =====
        function switchMode(mode) {
            APP_STATE.currentMode = mode;
            APP_STATE.historyData = [];
            APP_STATE.currentIndex = 0;

            // æ›´æ–°æ¡Œé¢ç‰ˆå°èˆª UI
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('bg-green-500/20', 'border-green-500', 'text-green-400');
                btn.classList.add('border-transparent');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('bg-green-500/20', 'border-green-500', 'text-green-400');
                    btn.classList.remove('border-transparent');
                }
            });

            // æ›´æ–°æ‰‹æ©Ÿç‰ˆå°èˆª UI
            document.querySelectorAll('.mobile-mode-btn').forEach(btn => {
                btn.classList.remove('bg-green-500/20', 'border-green-500', 'text-green-400');
                btn.classList.add('border-transparent');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('bg-green-500/20', 'border-green-500', 'text-green-400');
                    btn.classList.remove('border-transparent');
                }
            });

            // é¡¯ç¤ºå°æ‡‰è¦–åœ–
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${mode}`).classList.remove('hidden');

            // é¡¯ç¤º/éš±è—é€²åº¦æ¢
            if (['flashcard', 'quiz', 'typing', 'combine', 'listening'].includes(mode)) {
                document.getElementById('session-progress').classList.remove('hidden');
            } else {
                document.getElementById('session-progress').classList.add('hidden');
            }

            updateTopics();
            loadContent();
        }

        function updateTopics() {
            const select = document.getElementById('topic-select');
            const topics = TOPICS[APP_STATE.currentMode] || [];
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            select.innerHTML = topics.map((t, i) => `
                <option value="${t.value}">${t.label}</option>
            `).join('');

            // è¨­å®šç¬¬ä¸€å€‹ä¸»é¡Œç‚ºé è¨­
            if (topics.length > 0) {
                APP_STATE.currentTopic = topics[0].value;
                select.value = topics[0].value;
            }
            
            // åŒæ™‚æ›´æ–°æ‰‹æ©Ÿç‰ˆ
            updateMobileTopicSelect();
        }

        // ä¸»é¡Œä¸‹æ‹‰é¸å–®è®Šæ›´
        function onTopicChange() {
            const select = document.getElementById('topic-select');
            APP_STATE.currentTopic = select.value;
            APP_STATE.historyData = [];
            
            // åŒæ­¥æ‰‹æ©Ÿç‰ˆé¸å–®
            const mobileSelect = document.getElementById('mobile-topic-select');
            if (mobileSelect) mobileSelect.value = select.value;
            
            loadContent();
        }

        function selectTopic(topicValue) {
            APP_STATE.currentTopic = topicValue;
            APP_STATE.historyData = [];
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            const select = document.getElementById('topic-select');
            if (select) select.value = topicValue;
            
            const mobileSelect = document.getElementById('mobile-topic-select');
            if (mobileSelect) mobileSelect.value = topicValue;

            loadContent();
        }

        // é‡æ–°ç”Ÿæˆå…§å®¹ï¼ˆæ›ä¸€æ‰¹ï¼‰
        function regenerateContent() {
            // æŠŠç•¶å‰çš„å–®å­—åŠ å…¥æ’é™¤åˆ—è¡¨ï¼Œç¢ºä¿ä¸‹æ¬¡ä¸æœƒé‡è¤‡
            if (APP_STATE.words && APP_STATE.words.length > 0) {
                APP_STATE.words.forEach(w => {
                    if (!APP_STATE.historyData.includes(w.word)) {
                        APP_STATE.historyData.push(w.word);
                    }
                });
            }
            APP_STATE.currentIndex = 0;
            loadContent();
        }

        // é›£åº¦ç­‰ç´šè®Šæ›´æ™‚é‡æ–°è¼‰å…¥å…§å®¹
        function onLevelChange() {
            const level = document.getElementById('level-select').value;
            console.log('é›£åº¦åˆ‡æ›è‡³:', level);
            
            // æ¸…ç©ºç•¶å‰ session çš„æ­·å²ï¼ˆä½†ä¿ç•™æŒä¹…åŒ–çš„è¨˜éŒ„ï¼‰
            APP_STATE.historyData = [];
            APP_STATE.currentIndex = 0;
            
            // é‡æ–°è¼‰å…¥å…§å®¹
            loadContent();
        }

        // ===== Gemini API ç›´æ¥å‘¼å« (ä¸éœ€è¦ server.js) =====
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // CEFR ç­‰ç´šæè¿°
        const LEVEL_DESCRIPTIONS = {
            'A1': 'éå¸¸åŸºç¤çš„æ—¥å¸¸è©å½™ï¼Œé©åˆåˆå­¸è€…ï¼ˆç´„500å€‹æœ€å¸¸ç”¨å–®å­—ï¼‰',
            'A2': 'ç°¡å–®æ—¥å¸¸æƒ…å¢ƒçš„åˆç´šè©å½™ï¼ˆç´„1000-1500å€‹å¸¸ç”¨å–®å­—ï¼‰',
            'B1': 'ç†Ÿæ‚‰è©±é¡Œå’Œç°¡å–®è§€é»çš„ä¸­ç´šè©å½™ï¼ˆç´„2500å€‹å–®å­—ï¼‰',
            'B2': 'è¤‡é›œè©±é¡Œå’ŒæŠ½è±¡æ¦‚å¿µçš„ä¸­é«˜ç´šè©å½™ï¼ˆç´„4000å€‹å–®å­—ï¼‰',
            'C1': 'é€²éšè©å½™ï¼ŒåŒ…å«æ…£ç”¨èªå’Œç´°å¾®èªæ„å·®ç•°ï¼ˆç´„8000å€‹å–®å­—ï¼‰',
            'C2': 'æ¯èªè€…ç¨‹åº¦çš„ç²¾é€šè©å½™ï¼ŒåŒ…å«ç½•è¦‹è©ã€æ–‡å­¸ç”¨èªå’Œå°ˆæ¥­è¡“èªï¼ˆ10000+å–®å­—ï¼‰',
            'TOEIC': 'å¤šç›Šæ¸¬é©—å¸¸è€ƒè©å½™ï¼Œå•†å‹™ã€è·å ´ã€æ—¥å¸¸æºé€šæƒ…å¢ƒï¼ˆ600-900åˆ†ç¨‹åº¦ï¼‰',
            'IELTS': 'é›…æ€è€ƒè©¦å¿…å‚™è©å½™ï¼Œå­¸è¡“å¯«ä½œå’Œå£èªªé«˜é »è©ï¼ˆ6.0-8.0åˆ†ç¨‹åº¦ï¼‰',
            'TOEFL': 'æ‰˜ç¦å­¸è¡“è©å½™ï¼Œå¤§å­¸èª²å ‚ã€å­¸è¡“è«–æ–‡å¸¸è¦‹ç”¨èªï¼ˆ80-110åˆ†ç¨‹åº¦ï¼‰',
            'GRE': 'GRE é«˜ç´šå­¸è¡“è©å½™ï¼Œè‰±æ·±ç½•è¦‹ä½†è€ƒè©¦å¿…å‚™çš„å–®å­—',
            'BUSINESS': 'å•†æ¥­è‹±èªå°ˆæ¥­è©å½™ï¼Œæœƒè­°ã€ç°¡å ±ã€è«‡åˆ¤ã€è²¡å‹™ç”¨èª'
        };

        // éš¨æ©ŸæŒ‡ä»¤ï¼Œå¢åŠ å…§å®¹å¤šæ¨£æ€§
        const VARIETY_INSTRUCTIONS = [
            'Focus on less common but useful words that students often miss.',
            'Include some phrasal verbs or idiomatic expressions.',
            'Choose words that are practical for real conversations.',
            'Include a mix of nouns, verbs, and adjectives.',
            'Focus on words commonly used in movies and TV shows.',
            'Include words that are often confused or mispronounced.',
            'Choose words that have interesting etymology or stories.',
            'Focus on words used in professional settings.',
            'Include some compound words or collocations.',
            'Choose words that sound similar but have different meanings.',
            'Prioritize words with interesting visual or conceptual connections.',
            'Include words from different semantic fields and categories.',
            'Focus on words that are culturally significant or contextually rich.',
            'Choose words with multiple meanings or nuanced usage.',
            'Include words that are trending or commonly used in modern English.',
            'Focus on words that create vivid mental images.',
            'Choose words from different registers (formal, informal, slang).',
            'Include words that are fun to learn and memorable.',
            'Focus on words with interesting word formation patterns.',
            'Choose words that are useful for specific situations or scenarios.'
        ];

        // å–å¾—éš¨æ©ŸæŒ‡ä»¤
        function getRandomInstruction() {
            return VARIETY_INSTRUCTIONS[Math.floor(Math.random() * VARIETY_INSTRUCTIONS.length)];
        }

        // ç”¢ç”Ÿéš¨æ©Ÿç¨®å­å­—æ¯ï¼Œå¢åŠ è®ŠåŒ–
        function getRandomSeed() {
            const letters = 'abcdefghijklmnopqrstuvwxyz';
            const randomLetter = letters[Math.floor(Math.random() * letters.length)];
            const randomLetter2 = letters[Math.floor(Math.random() * letters.length)];
            const randomNum = Math.floor(Math.random() * 10) + 1;
            const seeds = [
                `Start with words beginning with "${randomLetter.toUpperCase()}".`,
                `Avoid words starting with common letters like A, B, C, E, S, T.`,
                `Include at least one word with ${randomNum}+ syllables.`,
                `Include words from different word families.`,
                `Mix formal and informal vocabulary.`,
                `Focus on words with ${randomNum}-${randomNum + 2} letters.`,
                `Prioritize words containing the letter "${randomLetter.toUpperCase()}" or "${randomLetter2.toUpperCase()}".`,
                `Include words that are ${randomNum * 10}% more advanced than basic level.`,
                `Choose words with interesting phonetic patterns.`,
                `Include words from ${randomNum} different semantic categories.`,
                ''  // æœ‰æ™‚ä¸åŠ é™åˆ¶
            ];
            return seeds[Math.floor(Math.random() * seeds.length)];
        }

        // ç”¢ç”Ÿè¤‡åˆè©å°ˆç”¨çš„éš¨æ©ŸæŒ‡ä»¤
        function getRandomCompoundInstruction() {
            const compoundTypes = [
                'noun + noun combinations',
                'adjective + noun combinations',
                'verb + noun combinations',
                'noun + verb combinations',
                'adjective + verb combinations'
            ];
            const themes = [
                'nature and environment',
                'technology and modern life',
                'emotions and feelings',
                'activities and actions',
                'objects and things',
                'places and locations',
                'time and seasons',
                'body and health',
                'food and cooking',
                'sports and hobbies'
            ];
            const randomType = compoundTypes[Math.floor(Math.random() * compoundTypes.length)];
            const randomTheme = themes[Math.floor(Math.random() * themes.length)];
            const randomNum = Math.floor(Math.random() * 5) + 3;
            
            const instructions = [
                `Focus on ${randomType} related to ${randomTheme}.`,
                `Include ${randomNum} different types of compound word patterns.`,
                `Prioritize compound words where both parts are common, everyday words.`,
                `Choose compound words that create new meanings beyond their parts.`,
                `Include compound words with interesting visual or conceptual connections.`,
                `Focus on compound words that are frequently used in daily conversation.`,
                `Include compound words from different word categories and themes.`,
                `Choose compound words where the combination creates a memorable image.`,
                `Prioritize compound words that are practical and useful.`,
                `Include compound words with different stress patterns.`
            ];
            return instructions[Math.floor(Math.random() * instructions.length)];
        }

        // ç”Ÿæˆ Prompt
        function generatePrompt(type, topic, level, exclude, userMessage) {
            const excludeText = (exclude && exclude.length > 0) ? exclude.join(", ") : "None";
            const levelDesc = LEVEL_DESCRIPTIONS[level] || LEVEL_DESCRIPTIONS['B1'];
            const randomInstruction = getRandomInstruction();
            const randomSeed = getRandomSeed();
            const timestamp = Date.now(); // å¢åŠ æ™‚é–“æˆ³ç¢ºä¿æ¯æ¬¡ä¸åŒ

            // å¸¸è¦‹å–®å­—é»‘åå–®ï¼ˆé¿å… AI ç¸½æ˜¯ç”Ÿæˆé€™äº›ï¼‰
            const commonWordsToAvoid = 'eat, drink, sleep, walk, run, talk, read, write, play, work, go, come, see, look, make, take, give, get, have, be, do, say, food, water, house, car, book, phone, computer, money, time, day, night, friend, family, school, office';

            // ç‰¹æ®Šè€ƒè©¦ç­‰ç´šçš„é¡å¤–æŒ‡ç¤º
            const examInstructions = {
                'TOEIC': 'Focus on TOEIC test vocabulary: business meetings, office communication, travel, shopping, dining. Include common TOEIC phrases.',
                'IELTS': 'Focus on IELTS academic vocabulary: essay writing, speaking test topics, graphs/charts description, formal academic language.',
                'TOEFL': 'Focus on TOEFL academic vocabulary: university lectures, scientific concepts, campus life, research terminology.',
                'GRE': 'Focus on GRE high-level vocabulary: sophisticated, rarely-used academic words that appear on GRE verbal section.',
                'BUSINESS': 'Focus on business English: negotiations, presentations, financial terms, corporate communication, professional emails.',
                'C2': 'Focus on native-speaker level vocabulary: literary words, rare expressions, nuanced synonyms, sophisticated collocations.'
            };
            const extraInstruction = examInstructions[level] || '';

            switch (type) {
                case 'vocab':
                    const randomIdVocab = Math.random().toString(36).substring(2, 9);
                    const randomVariationVocab = Math.floor(Math.random() * 1000);
                    
                    return `You are an expert English vocabulary teacher. Generate UNIQUE and INTERESTING vocabulary.

**Context:**
- Topic: "${topic}"
- Level: ${level} (${levelDesc})
- Request ID: ${timestamp}-${randomIdVocab}-${randomVariationVocab} (generate COMPLETELY DIFFERENT words each time)
- Session Variation: ${Math.floor(Math.random() * 10000)}
${extraInstruction ? `\n**EXAM FOCUS:** ${extraInstruction}` : ''}

**IMPORTANT EXCLUSIONS - Do NOT use these words:**
- Already learned: [${excludeText}]
- Too common/basic: [${commonWordsToAvoid}]

**Special Instructions for variety:**
- ${randomInstruction}
- ${randomSeed}

**Task:** Generate exactly 5 UNIQUE vocabulary words that:
1. Are specifically relevant to "${topic}"
2. Match ${level} difficulty level
3. Are NOT in any exclusion list above
4. Are interesting and memorable
5. Would surprise and engage the learner
6. **CRITICAL: Generate DIFFERENT words every time. Avoid repeating the same words from previous requests.**

**Output Format (JSON only, no markdown):**
{
    "title": "Topic title in English",
    "words": [
        {
            "word": "English word",
            "pos": "noun/verb/adj/adv/phrase",
            "mean": "ç¹é«”ä¸­æ–‡è§£é‡‹ï¼ˆç°¡æ½”æ˜ç¢ºï¼‰",
            "example": "A natural example sentence using the word",
            "trans": "ä¾‹å¥çš„ç¹é«”ä¸­æ–‡ç¿»è­¯"
        }
    ]
}`;

                case 'combine':
                    const randomCompoundInstruction = getRandomCompoundInstruction();
                    const randomId = Math.random().toString(36).substring(2, 9);
                    const randomVariation = Math.floor(Math.random() * 1000);
                    
                    return `You are an expert English vocabulary teacher. Generate COMPOUND WORDS (è¤‡åˆè©) for word combination practice.

**Context:**
- Topic: "${topic}"
- Level: ${level} (${levelDesc})
- Request ID: ${timestamp}-${randomId}-${randomVariation} (generate COMPLETELY DIFFERENT words each time)
- Session Variation: ${Math.floor(Math.random() * 10000)}
${extraInstruction ? `\n**EXAM FOCUS:** ${extraInstruction}` : ''}

**IMPORTANT EXCLUSIONS - Do NOT use these words:**
- Already learned: [${excludeText}]
- Too common/basic: [${commonWordsToAvoid}]

**RANDOM VARIATION INSTRUCTIONS:**
- ${randomCompoundInstruction}
- ${randomInstruction}
- ${randomSeed}

**CRITICAL REQUIREMENTS:**
1. Generate ONLY compound words (è¤‡åˆè©) where the word is made of TWO meaningful parts
2. Each part must be a valid English word with its own meaning
3. Examples: rainbow (rain + bow), butterfly (butter + fly), sunflower (sun + flower), notebook (note + book)
4. Each part should have a clear, simple meaning that students can understand
5. The combined word should be relevant to "${topic}"
6. Match ${level} difficulty level
7. **IMPORTANT: Generate UNIQUE and DIFFERENT words every time. Do NOT repeat common examples like rainbow, butterfly, sunflower unless specifically requested.**

**Output Format (JSON only, no markdown):**
{
    "title": "Topic title in English",
    "words": [
        {
            "word": "complete compound word (e.g., rainbow)",
            "pos": "noun/verb/adj/adv",
            "mean": "å®Œæ•´å–®å­—çš„ç¹é«”ä¸­æ–‡è§£é‡‹ï¼ˆç°¡æ½”æ˜ç¢ºï¼‰",
            "part1": {
                "word": "first part (e.g., rain)",
                "mean": "ç¬¬ä¸€éƒ¨åˆ†çš„ç¹é«”ä¸­æ–‡è§£é‡‹"
            },
            "part2": {
                "word": "second part (e.g., bow)",
                "mean": "ç¬¬äºŒéƒ¨åˆ†çš„ç¹é«”ä¸­æ–‡è§£é‡‹"
            },
            "example": "A natural example sentence using the compound word",
            "trans": "ä¾‹å¥çš„ç¹é«”ä¸­æ–‡ç¿»è­¯"
        }
    ]
}

**IMPORTANT:** Each word MUST have both part1 and part2 with their meanings. Do NOT generate words that cannot be split into two meaningful parts.`;

                case 'grammar':
                    const randomIdGrammar = Math.random().toString(36).substring(2, 9);
                    const randomVariationGrammar = Math.floor(Math.random() * 1000);
                    
                    return `You are an expert English grammar teacher creating interactive quiz content.

**Context:**
- Grammar Topic: "${topic}"
- CEFR Level: ${level} (${levelDesc})
- Request ID: ${timestamp}-${randomIdGrammar}-${randomVariationGrammar} (generate COMPLETELY DIFFERENT content each time)
- Session Variation: ${Math.floor(Math.random() * 10000)}
- Previously used content to avoid: [${excludeText}]

**RANDOM VARIATION INSTRUCTIONS:**
- ${randomInstruction}
- Create questions with different sentence structures and contexts
- Use varied vocabulary and real-world scenarios
- Include different question types (fill-in-blank, multiple choice, sentence correction)

**Task:** Create a grammar lesson with 3 UNIQUE quiz questions that are DIFFERENT from previous requests.

**Output Format (JSON only, no markdown):**
{
    "concept": "Grammar concept name in English",
    "explanation": "æ¸…æ™°çš„ç¹é«”ä¸­æ–‡æ–‡æ³•è§£é‡‹ï¼ŒåŒ…å«ä½¿ç”¨æ™‚æ©Ÿå’Œæ³¨æ„äº‹é …",
    "example_sentences": ["Example 1", "Example 2"],
    "quiz": [
        {
            "question": "Fill in the blank: She ___ to school yesterday.",
            "options": ["go", "goes", "went", "going"],
            "answer": 2,
            "reason": "ç¹é«”ä¸­æ–‡è§£é‡‹ç‚ºä»€éº¼é€™å€‹é¸é …æ­£ç¢º"
        }
    ]
}`;

                case 'chat':
                    // æª¢æ¸¬æ˜¯å¦ç‚ºä¸­æ–‡è¼¸å…¥
                    const isChinese = /[\u4e00-\u9fff]/.test(userMessage);
                    
                    if (isChinese) {
                        // ä¸­æ–‡è¼¸å…¥æ¨¡å¼ - æ•™ç”¨æˆ¶æ€éº¼èªªè‹±æ–‡
                        return `You are a friendly English tutor helping a student learn to express themselves in English.

**Scenario:** ${topic}
**User's Level:** ${level} (${levelDesc})
**User said in Chinese:** "${userMessage}"

**Your Task:**
1. First, understand what the user wants to say in Chinese
2. Teach them how to say it naturally in English (provide 2-3 different ways if possible)
3. Give a sample conversation response as if you're the other person in the scenario
4. Provide pronunciation tips or common mistakes to avoid

**Output Format (JSON only, no markdown):**
{
    "reply": "Great question! Here's how you can say that in English...",
    "chinese": "ä½ çš„å›è¦†çš„ç¹é«”ä¸­æ–‡ç¿»è­¯",
    "teaching": {
        "userWanted": "ç”¨æˆ¶æƒ³è¡¨é”çš„æ„æ€",
        "expressions": [
            {"english": "First way to say it", "explanation": "è§£é‡‹é€™å€‹èªªæ³•çš„èªå¢ƒ"},
            {"english": "Second way (more casual)", "explanation": "è§£é‡‹"},
            {"english": "Third way (more formal)", "explanation": "è§£é‡‹"}
        ],
        "sampleDialogue": "A: (ç”¨æˆ¶å¯ä»¥èªªçš„è©±)\\nB: (å°æ–¹å¯èƒ½çš„å›æ‡‰)",
        "tips": "ç™¼éŸ³æç¤ºæˆ–å¸¸è¦‹éŒ¯èª¤"
    },
    "score": null,
    "feedback": "é¼“å‹µç”¨æˆ¶çš„è©±ï¼Œä¸¦å»ºè­°ä»–å€‘è©¦è‘—ç”¨è‹±æ–‡èªªèªªçœ‹"
}`;
                    } else {
                        // è‹±æ–‡è¼¸å…¥æ¨¡å¼ - è‡ªç”±å°è©±ä¸¦è©•åˆ†
                        return `You are a friendly and encouraging English conversation partner. Have a natural, flowing conversation while helping the user improve.

**Scenario:** ${topic}
**User's Level:** ${level} (${levelDesc})
**User said:** "${userMessage}"

**Your Task:**
1. Respond naturally and conversationally (like a real person, not a textbook)
2. Keep the conversation going - ask follow-up questions or share related thoughts
3. Match your vocabulary and complexity to ${level} level
4. Analyze their English carefully and give specific feedback

**Scoring Guidelines (be honest and specific):**
- 90-100: Native-like, no errors, natural expressions
- 80-89: Very good, minor issues only
- 70-79: Good, some grammar/vocabulary issues but understandable
- 60-69: OK, noticeable errors but message is clear
- 50-59: Needs work, several errors affecting clarity
- Below 50: Major issues, hard to understand

**Output Format (JSON only, no markdown):**
{
    "reply": "Your natural, conversational response (2-4 sentences). Keep it flowing!",
    "chinese": "å›è¦†çš„ç¹é«”ä¸­æ–‡ç¿»è­¯",
    "score": [æ ¹æ“šä¸Šè¿°æ¨™æº–çµ¦å‡ºçœŸå¯¦åˆ†æ•¸],
    "feedback": "å…·é«”æŒ‡å‡ºï¼š1) åšå¾—å¥½çš„åœ°æ–¹ 2) å¯ä»¥æ”¹é€²çš„åœ°æ–¹ 3) æ›´è‡ªç„¶çš„èªªæ³•å»ºè­°ï¼ˆç”¨ç¹é«”ä¸­æ–‡ï¼‰",
    "corrections": [
        {"original": "ç”¨æˆ¶èªªéŒ¯çš„éƒ¨åˆ†", "corrected": "æ­£ç¢ºèªªæ³•", "reason": "ç°¡çŸ­èªªæ˜"}
    ]
}`; 
                    }

                default:
                    return `Generate a simple greeting in JSON format: {"message": "Hello!"}`;
            }
        }

        // å‘¼å« Gemini API
        async function callGeminiAPI(prompt) {
            const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                    method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 1.2,  // æé«˜éš¨æ©Ÿæ€§ï¼ˆæœ€é«˜å¯åˆ° 2.0ï¼‰
                        topP: 0.9,        // å¢åŠ å¤šæ¨£æ€§
                        topK: 50,         // å¢åŠ å€™é¸è©æ•¸é‡
                        maxOutputTokens: 2048
                    }
                    })
                });
                
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API å‘¼å«å¤±æ•—');
            }

            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            
            // æ¸…ç† JSONï¼ˆç§»é™¤ markdown æ¨™è¨˜ï¼‰
            let cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const firstBrace = cleanText.indexOf('{');
            const lastBrace = cleanText.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) {
                cleanText = cleanText.substring(firstBrace, lastBrace + 1);
            }
            
            return JSON.parse(cleanText);
        }

        // ===== å…§å®¹è¼‰å…¥ =====
        async function loadContent() {
            if (APP_STATE.currentMode === 'chat') {
                initChat();
                return;
            }

            document.getElementById('loading').classList.remove('hidden');

            try {
                let type;
                if (APP_STATE.currentMode === 'combine') {
                    type = 'combine';
                } else if (['flashcard', 'quiz', 'typing', 'listening'].includes(APP_STATE.currentMode)) {
                    type = 'vocab';
                } else {
                    type = APP_STATE.currentMode;
                }
                
                // åˆä½µæŒä¹…åŒ–çš„å­¸ç¿’è¨˜éŒ„ + ç•¶å‰ session çš„è¨˜éŒ„
                const persistentHistory = getLearnedWordsForTopic(APP_STATE.currentTopic);
                const allExcluded = [...new Set([...persistentHistory, ...APP_STATE.historyData])];
                
                const prompt = generatePrompt(
                    type,
                    APP_STATE.currentTopic,
                    document.getElementById('level-select').value,
                    allExcluded
                );

                const data = await callGeminiAPI(prompt);
                
                if (data.words) {
                    // éš¨æ©Ÿæ‰“äº‚å–®å­—é †åºï¼Œå¢åŠ æ¯æ¬¡è¼‰å…¥çš„è®ŠåŒ–
                    const shuffledWords = [...data.words];
                    for (let i = shuffledWords.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffledWords[i], shuffledWords[j]] = [shuffledWords[j], shuffledWords[i]];
                    }
                    APP_STATE.words = shuffledWords;
                    APP_STATE.words.forEach(w => APP_STATE.historyData.push(w.word));
                    // éš¨æ©Ÿé¸æ“‡èµ·å§‹ä½ç½®ï¼ˆä½†é€šå¸¸å¾ç¬¬ä¸€å€‹é–‹å§‹ï¼‰
                    APP_STATE.currentIndex = Math.random() < 0.1 ? Math.floor(Math.random() * Math.min(3, shuffledWords.length)) : 0;
                    renderCurrentMode();
                } else if (data.concept) {
                    renderGrammar(data);
                }

            } catch (e) {
                console.error(e);
                alert('è¼‰å…¥å¤±æ•—ï¼š' + e.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderCurrentMode() {
            updateProgress();
            
            switch (APP_STATE.currentMode) {
                case 'flashcard':
                    renderFlashcard();
                    break;
                case 'quiz':
                    renderQuiz();
                    break;
                case 'typing':
                    renderTyping();
                    break;
                case 'combine':
                    renderCombine();
                    break;
                case 'listening':
                    renderListening();
                    break;
            }
        }

        function updateProgress() {
            const total = APP_STATE.words.length;
            const current = APP_STATE.currentIndex + 1;
            document.getElementById('current-idx').textContent = current;
            document.getElementById('total-items').textContent = total;
            document.getElementById('session-bar').style.width = (current / total * 100) + '%';
        }

        // ===== é–ƒå¡æ¨¡å¼ =====
        function renderFlashcard() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            // é‡ç½®ç¿»è½‰ç‹€æ…‹
            document.querySelector('.flashcard').classList.remove('flipped');
            APP_STATE.isFlipped = false;

            document.getElementById('card-word').textContent = word.word;
            document.getElementById('card-pos').textContent = word.pos;
            document.getElementById('card-mean').textContent = word.mean;
            document.getElementById('card-example').textContent = `"${word.example}"`;
            document.getElementById('card-trans').textContent = word.trans || '';
        }

        function flipCard() {
            const card = document.querySelector('.flashcard');
            card.classList.toggle('flipped');
            APP_STATE.isFlipped = !APP_STATE.isFlipped;
        }

        function rateCard(rating) {
            let xp = 0;
            switch (rating) {
                case 'hard': xp = 5; break;
                case 'good': xp = 10; break;
                case 'easy': xp = 15; break;
            }
            
            addXP(xp);
            
            // è¨˜éŒ„å­¸éçš„å–®å­—ï¼ˆæŒä¹…åŒ–å„²å­˜ï¼‰
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                saveLearnedWord(word.word, APP_STATE.currentTopic);
            }

            nextWord();
        }

        // ===== é¸æ“‡é¡Œæ¨¡å¼ =====
        function renderQuiz() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            document.getElementById('quiz-word').textContent = word.word;
            document.getElementById('quiz-feedback').classList.add('hidden');

            // ç”Ÿæˆé¸é … (1å€‹æ­£ç¢º + 3å€‹éŒ¯èª¤)
            const options = [word.mean];
            const otherWords = APP_STATE.words.filter((w, i) => i !== APP_STATE.currentIndex);
            while (options.length < 4 && otherWords.length > 0) {
                const idx = Math.floor(Math.random() * otherWords.length);
                if (!options.includes(otherWords[idx].mean)) {
                    options.push(otherWords[idx].mean);
                }
                otherWords.splice(idx, 1);
            }

            // è£œè¶³é¸é …
            const fillers = ['è˜‹æœ', 'æ›¸æœ¬', 'é›»è…¦', 'éŸ³æ¨‚', 'åŸå¸‚'];
            while (options.length < 4) {
                options.push(fillers[options.length]);
            }

            // æ‰“äº‚é †åº
            options.sort(() => Math.random() - 0.5);

            document.getElementById('quiz-options').innerHTML = options.map((opt, i) => `
                <button onclick="checkQuizAnswer(this, '${opt}', '${word.mean}')" 
                    class="btn-option w-full py-4 rounded-xl text-left px-6 text-lg font-semibold">
                    ${opt}
                </button>
                `).join('');
        }

        function checkQuizAnswer(btn, selected, correct) {
            if (APP_STATE.isAnswered) return;
            APP_STATE.isAnswered = true;

            const isCorrect = selected === correct;
            userData.totalAnswered++;
            if (isCorrect) userData.totalCorrect++;
            saveUserData();

            if (isCorrect) {
                btn.classList.add('correct');
                playSound('correct');
                addXP(10);
                showFeedback('quiz-feedback', true, 'ç­”å°äº†ï¼', '');
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                showFeedback('quiz-feedback', false, 'å†æƒ³æƒ³...', `æ­£ç¢ºç­”æ¡ˆï¼š${correct}`);
                
                // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
                document.querySelectorAll('#quiz-options button').forEach(b => {
                    if (b.textContent.trim() === correct) {
                        b.classList.add('correct');
                    }
                });
            }

            setTimeout(nextWord, 1500);
        }

        // ===== æ‹¼å¯«æ¨¡å¼ =====
        function renderTyping() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            document.getElementById('typing-hint').textContent = word.mean;
            document.getElementById('typing-pos').textContent = word.pos;
            document.getElementById('typing-input').value = '';
            document.getElementById('typing-feedback').classList.add('hidden');
            document.getElementById('typing-input').focus();
        }

        function checkTyping() {
            if (APP_STATE.isAnswered) return;
            
            const word = APP_STATE.words[APP_STATE.currentIndex];
            const input = document.getElementById('typing-input').value.trim().toLowerCase();
            const correct = word.word.toLowerCase();

            APP_STATE.isAnswered = true;
            userData.totalAnswered++;

            if (input === correct) {
                userData.totalCorrect++;
                saveUserData();
                playSound('correct');
                addXP(15);
                showFeedback('typing-feedback', true, 'å®Œç¾ï¼', '');
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
            } else {
                saveUserData();
                playSound('wrong');
                showFeedback('typing-feedback', false, 'å·®ä¸€é»ï¼', `æ­£ç¢ºç­”æ¡ˆï¼š${word.word}`);
            }

            setTimeout(nextWord, 1500);
        }

        // ===== å–®å­—çµ„åˆæ¨¡å¼ =====
        function renderCombine() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            document.getElementById('combine-hint').textContent = word.mean;
            document.getElementById('combine-pos').textContent = word.pos;
            document.getElementById('combine-input').value = '';
            document.getElementById('combine-feedback').classList.add('hidden');
            
            // ä½¿ç”¨è¤‡åˆè©çš„å…©å€‹éƒ¨åˆ†
            if (word.part1 && word.part2) {
                document.getElementById('combine-part1').textContent = word.part1.word;
                document.getElementById('combine-part1-mean').textContent = word.part1.mean;
                document.getElementById('combine-part2').textContent = word.part2.word;
                document.getElementById('combine-part2-mean').textContent = word.part2.mean;
            } else {
                // å¦‚æœè³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                document.getElementById('combine-part1').textContent = '?';
                document.getElementById('combine-part1-mean').textContent = 'è³‡æ–™éŒ¯èª¤';
                document.getElementById('combine-part2').textContent = '?';
                document.getElementById('combine-part2-mean').textContent = 'è³‡æ–™éŒ¯èª¤';
            }
            
            document.getElementById('combine-result').textContent = '?';
            document.getElementById('combine-result').classList.remove('border-green-500', 'bg-green-500/20', 'text-green-300', 'border-red-500', 'bg-red-500/20', 'text-red-300');
            document.getElementById('combine-result').classList.add('border-dashed', 'border-white/30', 'text-white');
            
            // å„²å­˜æ­£ç¢ºç­”æ¡ˆä¾›æª¢æŸ¥ä½¿ç”¨
            APP_STATE.combineAnswer = word.word;
            
            document.getElementById('combine-input').focus();
        }

        function checkCombine() {
            if (APP_STATE.isAnswered) return;
            
            const input = document.getElementById('combine-input').value.trim().toLowerCase();
            const correct = APP_STATE.combineAnswer.toLowerCase();

            APP_STATE.isAnswered = true;
            userData.totalAnswered++;

            if (input === correct) {
                userData.totalCorrect++;
                saveUserData();
                playSound('correct');
                addXP(15);
                showFeedback('combine-feedback', true, 'å®Œç¾çµ„åˆï¼', '');
                document.getElementById('combine-result').textContent = correct;
                document.getElementById('combine-result').classList.remove('border-dashed', 'border-white/30');
                document.getElementById('combine-result').classList.add('border-green-500', 'bg-green-500/20', 'text-green-300');
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
            } else {
                saveUserData();
                playSound('wrong');
                showFeedback('combine-feedback', false, 'å†è©¦è©¦çœ‹ï¼', `æ­£ç¢ºç­”æ¡ˆï¼š${correct}`);
                document.getElementById('combine-result').textContent = correct;
                document.getElementById('combine-result').classList.remove('border-dashed', 'border-white/30');
                document.getElementById('combine-result').classList.add('border-red-500', 'bg-red-500/20', 'text-red-300');
            }

            setTimeout(() => {
                document.getElementById('combine-result').classList.remove('border-green-500', 'bg-green-500/20', 'text-green-300', 'border-red-500', 'bg-red-500/20', 'text-red-300');
                document.getElementById('combine-result').classList.add('border-dashed', 'border-white/30', 'text-white');
            }, 1500);
            
            setTimeout(nextWord, 1500);
        }

        // ===== è½åŠ›æ¨¡å¼ =====
        function renderListening() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            document.getElementById('listening-feedback').classList.add('hidden');

            // ç”Ÿæˆé¸é …
            const options = [word.word];
            const otherWords = APP_STATE.words.filter((w, i) => i !== APP_STATE.currentIndex);
            while (options.length < 4 && otherWords.length > 0) {
                const idx = Math.floor(Math.random() * otherWords.length);
                if (!options.includes(otherWords[idx].word)) {
                    options.push(otherWords[idx].word);
                }
                otherWords.splice(idx, 1);
            }
            options.sort(() => Math.random() - 0.5);

            document.getElementById('listening-options').innerHTML = options.map(opt => `
                <button onclick="checkListeningAnswer(this, '${opt}', '${word.word}')" 
                    class="btn-option py-6 rounded-xl text-lg font-bold">
                    ${opt}
                </button>
            `).join('');

            // è‡ªå‹•æ’­æ”¾
            setTimeout(playListeningWord, 500);
        }

        function playListeningWord() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;
            
            // è½åŠ›æ¨¡å¼ç”¨è¼ƒæ…¢é€Ÿåº¦ï¼Œæ›´æ¸…æ™°
            speakText(word.word, 0.65);
            
            document.getElementById('sound-waves').classList.remove('hidden');
            setTimeout(() => document.getElementById('sound-waves').classList.add('hidden'), 2000);
        }

        // è½åŠ›æ¨¡å¼é‡æ–°æ’­æ”¾ï¼ˆæ…¢é€Ÿï¼‰
        function replayListeningSlow() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) speakText(word.word, 0.45);
        }

        // æ’­æ”¾å°è©±è¨Šæ¯
        function speakChatMessage(btn, rate = 0.8) {
            const text = btn.dataset.text;
            if (text) {
                // é‚„åŸ HTML å¯¦é«”
                const decodedText = text.replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, '&');
                speakText(decodedText, rate);
            }
        }

        function checkListeningAnswer(btn, selected, correct) {
            if (APP_STATE.isAnswered) return;
            APP_STATE.isAnswered = true;

            userData.totalAnswered++;
            const isCorrect = selected === correct;
            if (isCorrect) userData.totalCorrect++;
            saveUserData();

            if (isCorrect) {
                btn.classList.add('correct');
                playSound('correct');
                addXP(10);
                showFeedback('listening-feedback', true, 'è½åŠ›å¾ˆæ£’ï¼', '');
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                showFeedback('listening-feedback', false, 'å†è½ä¸€æ¬¡', `æ­£ç¢ºç­”æ¡ˆï¼š${correct}`);
            }

            setTimeout(nextWord, 1500);
        }

        // ===== æ–‡æ³•æ¨¡å¼ =====
        function renderGrammar(data) {
            document.getElementById('grammar-concept').textContent = data.concept;
            document.getElementById('grammar-explanation').textContent = data.explanation;

            document.getElementById('grammar-quiz').innerHTML = data.quiz.map((q, idx) => `
                <div class="bg-white/5 rounded-xl p-4">
                    <p class="font-bold mb-3">${q.question}</p>
                    <div class="space-y-2">
                                        ${q.options.map((opt, i) => `
                            <button onclick="checkGrammarAnswer(this, ${i}, ${q.answer}, '${q.reason}')"
                                class="btn-option w-full py-3 px-4 rounded-lg text-left text-sm">
                                                ${opt}
                                            </button>
                                        `).join('')}
                                    </div>
                    <div class="grammar-feedback hidden mt-3 p-3 rounded-lg text-sm"></div>
                                </div>
            `).join('');
        }

        function checkGrammarAnswer(btn, selected, correct, reason) {
            const container = btn.closest('.space-y-2');
            const feedback = btn.closest('.bg-white\\/5').querySelector('.grammar-feedback');
            
            if (selected === correct) {
                btn.classList.add('correct');
                playSound('correct');
                addXP(10);
                feedback.innerHTML = `<span class="text-green-400">âœ“ ${reason}</span>`;
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                feedback.innerHTML = `<span class="text-red-400">âœ— ${reason}</span>`;
            }
            feedback.classList.remove('hidden');

            // ç¦ç”¨æ‰€æœ‰é¸é …
            container.querySelectorAll('button').forEach(b => b.disabled = true);
        }

        // ===== AI å°è©±æ¨¡å¼ =====
        // å–å¾—ä¸»é¡Œçš„ä¸­æ–‡æ¨™ç±¤
        function getTopicLabel(value) {
            const topics = TOPICS[APP_STATE.currentMode] || [];
            const topic = topics.find(t => t.value === value);
            return topic ? topic.label : value;
        }

        // æƒ…å¢ƒå°è©±çš„ä¸­æ–‡æ­¡è¿èª
        const CHAT_GREETINGS = {
            'Coffee Shop': { greeting: 'Hello! Welcome to our cafÃ©. What can I get for you today?', chinese: 'ä½ å¥½ï¼æ­¡è¿ä¾†åˆ°æˆ‘å€‘çš„å’–å•¡å»³ã€‚ä»Šå¤©æƒ³å–é»ä»€éº¼ï¼Ÿ' },
            'Job Interview': { greeting: "Good morning! Thank you for coming in today. Please have a seat. Let's start with you telling me a bit about yourself.", chinese: 'æ—©å®‰ï¼æ„Ÿè¬æ‚¨ä»Šå¤©å‰ä¾†ã€‚è«‹åã€‚è®“æˆ‘å€‘å¾æ‚¨çš„è‡ªæˆ‘ä»‹ç´¹é–‹å§‹å§ã€‚' },
            'Airport': { greeting: 'Good day! May I see your passport and boarding pass, please?', chinese: 'æ‚¨å¥½ï¼è«‹å‡ºç¤ºæ‚¨çš„è­·ç…§å’Œç™»æ©Ÿè­‰ã€‚' },
            'Hotel Check-in': { greeting: 'Welcome to our hotel! Do you have a reservation with us?', chinese: 'æ­¡è¿å…‰è‡¨ï¼è«‹å•æ‚¨æœ‰é è¨‚å—ï¼Ÿ' },
            'Restaurant': { greeting: 'Good evening! Welcome to our restaurant. Table for how many?', chinese: 'æ™šå®‰ï¼æ­¡è¿å…‰è‡¨ã€‚è«‹å•å¹¾ä½ï¼Ÿ' },
            'Doctor Visit': { greeting: "Hello, I'm Dr. Smith. What brings you in today? How are you feeling?", chinese: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯å²å¯†æ–¯é†«ç”Ÿã€‚ä»Šå¤©æ˜¯ä»€éº¼å•é¡Œå‘¢ï¼Ÿæ‚¨ç¾åœ¨æ„Ÿè¦ºå¦‚ä½•ï¼Ÿ' }
        };

        function initChat() {
            const scenarioValue = APP_STATE.currentTopic;
            const scenarioLabel = getTopicLabel(scenarioValue);
            const chatInfo = CHAT_GREETINGS[scenarioValue] || { 
                greeting: `Hi! Welcome to our ${scenarioValue} scenario. Let's practice some English conversation.`,
                chinese: `å—¨ï¼æ­¡è¿ä¾†åˆ°${scenarioLabel}æƒ…å¢ƒã€‚è®“æˆ‘å€‘ç·´ç¿’è‹±èªå°è©±ã€‚`
            };

            document.getElementById('chat-scenario').textContent = scenarioLabel;
            document.getElementById('chat-messages').innerHTML = `
                <div class="flex gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-robot text-lg"></i>
                    </div>
                    <div class="glass-card rounded-2xl rounded-tl-sm p-4 max-w-[80%]">
                        <div class="flex items-start justify-between gap-2">
                            <p class="text-lg flex-1">${chatInfo.greeting}</p>
                            <button onclick="speakChatMessage(this)" data-text="${chatInfo.greeting.replace(/"/g, '&quot;')}" 
                                class="shrink-0 w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400 hover:bg-blue-500/30 transition" title="æ’­æ”¾èªéŸ³">
                                <i class="fa-solid fa-volume-high text-sm"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-400 mt-2 border-t border-white/10 pt-2">${chatInfo.chinese}</p>
                        <p class="text-xs text-blue-400 mt-2"><i class="fa-solid fa-lightbulb mr-1"></i>æç¤ºï¼šç”¨è‹±æ–‡å›è¦†ï¼Œç·´ç¿’å°è©±ï¼</p>
                    </div>
                </div>
            `;
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const messagesContainer = document.getElementById('chat-messages');

            // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            messagesContainer.innerHTML += `
                <div class="flex gap-3 justify-end">
                    <div class="bg-blue-500/20 border border-blue-500/30 rounded-2xl rounded-tr-sm p-4 max-w-[80%]">
                        <p>${message}</p>
                        </div>
                                </div>
            `;

            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // é¡¯ç¤ºè¼‰å…¥
            const loadingId = 'typing-' + Date.now();
            messagesContainer.innerHTML += `
                <div id="${loadingId}" class="flex gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="glass-card rounded-2xl rounded-tl-sm p-4">
                        <div class="flex gap-1">
                            <span class="w-2 h-2 bg-white/50 rounded-full animate-bounce"></span>
                            <span class="w-2 h-2 bg-white/50 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                            <span class="w-2 h-2 bg-white/50 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        </div>
                        </div>
                    </div>
                `;

            try {
                const prompt = generatePrompt(
                    'chat',
                    APP_STATE.currentTopic,
                    document.getElementById('level-select').value,
                    [],
                    message
                );

                const data = await callGeminiAPI(prompt);
                document.getElementById(loadingId).remove();

                // æª¢æ¸¬ç”¨æˆ¶æ˜¯å¦ç”¨ä¸­æ–‡è¼¸å…¥
                const isChinese = /[\u4e00-\u9fff]/.test(message);
                
                // AI å›è¦† - è½‰ç¾©å¼•è™Ÿé¿å… HTML å•é¡Œ
                const safeReply = data.reply.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                
                if (isChinese && data.teaching) {
                    // ä¸­æ–‡è¼¸å…¥ - æ•™å­¸æ¨¡å¼
                    const teaching = data.teaching;
                    messagesContainer.innerHTML += `
                        <div class="flex gap-3 animate-slide">
                            <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-500 rounded-full flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-chalkboard-user"></i>
                            </div>
                            <div class="glass-card rounded-2xl rounded-tl-sm p-4 max-w-[85%]">
                                <div class="flex items-start justify-between gap-2 mb-3">
                                    <p class="flex-1">${data.reply}</p>
                                    <button onclick="speakChatMessage(this, 0.8)" data-text="${safeReply}" 
                                        class="shrink-0 w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400 hover:bg-blue-500/30 transition" title="æ’­æ”¾">
                                        <i class="fa-solid fa-volume-high text-sm"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">${data.chinese}</p>
                                
                                <!-- æ•™å­¸å…§å®¹ -->
                                <div class="bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/30 rounded-xl p-3 mb-3">
                                    <p class="text-xs text-amber-400 mb-2">ğŸ“š ä½ æƒ³èªªçš„æ˜¯ï¼š${teaching.userWanted || ''}</p>
                                    <p class="text-xs text-gray-400 mb-2">ä»¥ä¸‹æ˜¯å¹¾ç¨®è‹±æ–‡è¡¨é”æ–¹å¼ï¼š</p>
                                    <div class="space-y-2">
                                        ${(teaching.expressions || []).map((exp, i) => `
                                            <div class="flex items-start gap-2 bg-white/5 rounded-lg p-2">
                                                <span class="text-amber-400 font-bold text-xs">${i + 1}.</span>
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-green-400 font-medium">"${exp.english}"</span>
                                                        <button onclick="speakChatMessage(this, 0.7)" data-text="${exp.english.replace(/"/g, '&quot;')}" 
                                                            class="w-6 h-6 bg-green-500/20 rounded-full flex items-center justify-center text-green-400 hover:bg-green-500/30 transition" title="æ’­æ”¾">
                                                            <i class="fa-solid fa-volume-high text-xs"></i>
                                                        </button>
                                                    </div>
                                                    <p class="text-xs text-gray-400 mt-1">${exp.explanation || ''}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                ${teaching.sampleDialogue ? `
                                <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-3 mb-3">
                                    <p class="text-xs text-blue-400 mb-2">ğŸ’¬ å°è©±ç¯„ä¾‹ï¼š</p>
                                    <pre class="text-sm text-white whitespace-pre-wrap">${teaching.sampleDialogue}</pre>
                                </div>` : ''}
                                
                                ${teaching.tips ? `
                                <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-3">
                                    <p class="text-xs text-purple-400">ğŸ’¡ å°æç¤ºï¼š${teaching.tips}</p>
                                </div>` : ''}
                                
                                ${data.feedback ? `<p class="text-xs text-yellow-400 mt-3 pt-2 border-t border-white/10">âœ¨ ${data.feedback}</p>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // è‹±æ–‡è¼¸å…¥ - å°è©±è©•åˆ†æ¨¡å¼
                    messagesContainer.innerHTML += `
                        <div class="flex gap-3 animate-slide">
                            <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-robot"></i>
                            </div>
                            <div class="glass-card rounded-2xl rounded-tl-sm p-4 max-w-[80%]">
                                <div class="flex items-start justify-between gap-2">
                                    <p class="flex-1">${data.reply}</p>
                                    <div class="shrink-0 flex gap-1">
                                        <button onclick="speakChatMessage(this, 0.6)" data-text="${safeReply}" 
                                            class="w-8 h-8 bg-amber-500/20 rounded-full flex items-center justify-center text-amber-400 hover:bg-amber-500/30 transition" title="æ…¢é€Ÿæ’­æ”¾">
                                            <i class="fa-solid fa-volume-low text-xs"></i>
                                        </button>
                                        <button onclick="speakChatMessage(this, 0.85)" data-text="${safeReply}" 
                                            class="w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400 hover:bg-blue-500/30 transition" title="æ­£å¸¸æ’­æ”¾">
                                            <i class="fa-solid fa-volume-high text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">${data.chinese}</p>
                                
                                ${data.corrections && data.corrections.length > 0 ? `
                                <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-2 mt-3">
                                    <p class="text-xs text-red-400 mb-1">âœï¸ ä¿®æ­£å»ºè­°ï¼š</p>
                                    ${data.corrections.map(c => `
                                        <div class="text-xs mt-1">
                                            <span class="text-red-400 line-through">${c.original}</span>
                                            <span class="text-white mx-1">â†’</span>
                                            <span class="text-green-400">${c.corrected}</span>
                                            <span class="text-gray-500 block mt-0.5">${c.reason || ''}</span>
                                        </div>
                                    `).join('')}
                                </div>` : ''}
                                
                                ${data.feedback ? `<p class="text-xs text-yellow-400 mt-2 border-t border-white/10 pt-2">ğŸ’¡ ${data.feedback}</p>` : ''}
                                
                                ${data.score ? `
                                <div class="mt-3 pt-2 border-t border-white/10">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-400">è¡¨é”è©•åˆ†</span>
                                        <div class="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full transition-all duration-500 ${data.score >= 80 ? 'bg-green-500' : data.score >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${data.score}%"></div>
                                        </div>
                                        <span class="text-sm font-bold ${data.score >= 80 ? 'text-green-400' : data.score >= 60 ? 'text-yellow-400' : 'text-red-400'}">${data.score}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">
                                        ${data.score >= 90 ? 'ğŸŒŸ å¤ªæ£’äº†ï¼å¹¾ä¹åƒæ¯èªè€…ä¸€æ¨£ï¼' : 
                                          data.score >= 80 ? 'ğŸ‘ å¾ˆå¥½ï¼åªæœ‰ä¸€äº›å°åœ°æ–¹å¯ä»¥æ”¹é€²ã€‚' :
                                          data.score >= 70 ? 'ğŸ‘ ä¸éŒ¯ï¼ç¹¼çºŒç·´ç¿’æœƒæ›´å¥½ã€‚' :
                                          data.score >= 60 ? 'ğŸ’ª é‚„å¯ä»¥ï¼Œæ³¨æ„ä¸€ä¸‹æ–‡æ³•å’Œç”¨å­—ã€‚' :
                                          'ğŸ“š åŠ æ²¹ï¼å¤šç·´ç¿’å¹¾æ¬¡æœƒé€²æ­¥çš„ï¼'}
                                    </p>
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                }

                addXP(isChinese ? 3 : 5);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (e) {
                document.getElementById(loadingId).remove();
                console.error(e);
                alert('å°è©±å¤±æ•—ï¼š' + e.message);
            }
        }

        // ===== å·¥å…·å‡½æ•¸ =====
        function nextWord() {
            APP_STATE.currentIndex++;
            
            if (APP_STATE.currentIndex >= APP_STATE.words.length) {
                showCompletion();
            } else {
                renderCurrentMode();
            }
        }

        function showCompletion() {
            const earnedXP = APP_STATE.words.length * 10;
            document.getElementById('earned-xp').textContent = earnedXP;
            document.getElementById('complete-modal').classList.remove('hidden');
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        function continuelearning() {
            document.getElementById('complete-modal').classList.add('hidden');
            APP_STATE.currentIndex = 0;
            loadContent();
        }

        function showFeedback(elementId, isCorrect, title, subtitle) {
            const el = document.getElementById(elementId);
            el.classList.remove('hidden');
            el.className = `mt-6 p-4 rounded-xl text-center ${isCorrect ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;
            el.innerHTML = `<div class="font-bold">${title}</div>${subtitle ? `<div class="text-sm opacity-80">${subtitle}</div>` : ''}`;
        }

        // ===== èªéŸ³æ’­æ”¾åŠŸèƒ½ï¼ˆæ”¹å–„æ¸…æ™°åº¦ï¼‰=====
        let englishVoice = null;
        let voicesLoaded = false;

        // åˆå§‹åŒ–ä¸¦é¸æ“‡æœ€ä½³è‹±æ–‡èªéŸ³
        function initVoices() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return;
            
            voicesLoaded = true;
            
            // å„ªå…ˆé¸æ“‡é †åºï¼šGoogle > Microsoft > Apple > å…¶ä»–
            const preferredVoices = [
                'Google US English',
                'Google UK English Female',
                'Google UK English Male',
                'Microsoft Zira',
                'Microsoft David',
                'Samantha',           // macOS/iOS
                'Alex',               // macOS
                'Karen',              // Australian
                'Daniel',             // British
            ];
            
            // å˜—è©¦æ‰¾åˆ°æœ€ä½³èªéŸ³
            for (const preferred of preferredVoices) {
                const found = voices.find(v => v.name.includes(preferred));
                if (found) {
                    englishVoice = found;
                    console.log('é¸æ“‡èªéŸ³:', found.name);
                    break;
                }
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°å„ªå…ˆèªéŸ³ï¼Œé¸æ“‡ä»»ä½•è‹±æ–‡èªéŸ³
            if (!englishVoice) {
                englishVoice = voices.find(v => v.lang.startsWith('en-')) || voices[0];
                console.log('ä½¿ç”¨é è¨­èªéŸ³:', englishVoice?.name);
            }
        }

        // ç›£è½èªéŸ³åˆ—è¡¨è¼‰å…¥
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = initVoices;
            initVoices(); // ç«‹å³å˜—è©¦ä¸€æ¬¡
        }

        // é ç†±èªéŸ³å¼•æ“ï¼ˆè§£æ±ºç¬¬ä¸€å€‹å­—è¢«æˆªæ‰çš„å•é¡Œï¼‰
        let speechWarmedUp = false;
        function warmUpSpeech() {
            if (speechWarmedUp) return;
            const warmUp = new SpeechSynthesisUtterance('');
            warmUp.volume = 0;
            window.speechSynthesis.speak(warmUp);
            speechWarmedUp = true;
        }

        function speakWord() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                // å…ˆæ…¢é€Ÿæ’­æ”¾ä¸€æ¬¡ï¼Œå†æ­£å¸¸é€Ÿåº¦æ’­æ”¾
                speakText(word.word, 0.6, () => {
                    setTimeout(() => speakText(word.word, 0.85), 800);
                });
            }
        }

        function speakText(text, rate = 0.75, onEnd = null) {
            // å…ˆå–æ¶ˆä¹‹å‰çš„æ’­æ”¾
            window.speechSynthesis.cancel();
            
            // é ç†±å¼•æ“
            warmUpSpeech();
            
            // åœ¨å–®å­—å‰åŠ ä¸Šå¾®å°åœé “ï¼Œé¿å…ç¬¬ä¸€å€‹éŸ³ç¯€è¢«æˆªæ‰
            // ä½¿ç”¨é€—è™Ÿæœƒç”¢ç”Ÿè‡ªç„¶çš„çŸ­æš«åœé “
            const textWithPause = `, ${text}`;
            
            const utterance = new SpeechSynthesisUtterance(textWithPause);
            
            // ä½¿ç”¨æœ€ä½³èªéŸ³
            if (englishVoice) {
                utterance.voice = englishVoice;
            }
            
            utterance.lang = 'en-US';
            utterance.rate = rate;      // èªé€Ÿï¼ˆ0.1-10ï¼Œé è¨­1ï¼‰
            utterance.pitch = 1.0;      // éŸ³èª¿ï¼ˆ0-2ï¼Œé è¨­1ï¼‰
            utterance.volume = 1.0;     // éŸ³é‡ï¼ˆ0-1ï¼‰
            
            if (onEnd) {
                utterance.onend = onEnd;
            }
            
            // ä½¿ç”¨ setTimeout ç¢ºä¿å¼•æ“æº–å‚™å¥½
            setTimeout(() => {
                window.speechSynthesis.speak(utterance);
            }, 50);
        }

        // æ…¢é€Ÿæ’­æ”¾ï¼ˆçµ¦ç”¨æˆ¶æ‰‹å‹•é»æ“Šç”¨ï¼‰
        function speakSlow() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) speakText(word.word, 0.5);
        }

        // æ­£å¸¸é€Ÿåº¦æ’­æ”¾
        function speakNormal() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) speakText(word.word, 0.85);
        }

        function playSound(type) {
            try {
                const sound = document.getElementById(`sound-${type}`);
                sound.currentTime = 0;
                sound.volume = 0.3;
                sound.play().catch(() => {});
            } catch (e) {}
        }

        // ===== çµ±è¨ˆ =====
        function openStats() {
            document.getElementById('stat-streak').textContent = userData.streak;
            document.getElementById('stat-xp').textContent = userData.xp;
            document.getElementById('stat-words').textContent = userData.wordsLearned?.length || 0;
            const accuracy = userData.totalAnswered > 0 
                ? Math.round(userData.totalCorrect / userData.totalAnswered * 100) 
                : 0;
            document.getElementById('stat-accuracy').textContent = accuracy + '%';
            
            // æ›´æ–°å·²å­¸å–®å­—åˆ—è¡¨
            updateLearnedWordsList();
            
            document.getElementById('stats-modal').classList.remove('hidden');
        }

        function closeStats() {
            document.getElementById('stats-modal').classList.add('hidden');
        }

        // åˆ‡æ›é¡¯ç¤ºå·²å­¸å–®å­—
        function toggleLearnedWords() {
            const list = document.getElementById('learned-words-list');
            const text = document.getElementById('toggle-words-text');
            const icon = document.getElementById('toggle-words-icon');
            
            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                text.textContent = 'æ”¶åˆ';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            } else {
                list.classList.add('hidden');
                text.textContent = 'å±•é–‹';
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            }
        }

        // æ›´æ–°å·²å­¸å–®å­—åˆ—è¡¨
        function updateLearnedWordsList() {
            const container = document.getElementById('learned-words-list');
            const history = userData.learnedHistory || {};
            
            if (Object.keys(history).length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center">é‚„æ²’æœ‰å­¸ç¿’è¨˜éŒ„</p>';
                return;
            }

            let html = '';
            for (const [topic, words] of Object.entries(history)) {
                if (words.length > 0) {
                    html += `
                        <div class="mb-3">
                            <div class="text-xs text-gray-400 mb-1">${topic} (${words.length})</div>
                            <div class="flex flex-wrap gap-1">
                                ${words.map(w => `<span class="text-xs bg-white/10 px-2 py-1 rounded">${w}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            container.innerHTML = html || '<p class="text-gray-500 text-sm text-center">é‚„æ²’æœ‰å­¸ç¿’è¨˜éŒ„</p>';
        }

        // æ¸…é™¤å­¸ç¿’è¨˜éŒ„ï¼ˆä½†ä¿ç•™ XP ç­‰æ•¸æ“šï¼‰
        function clearLearnedHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤å­¸ç¿’è¨˜éŒ„å—ï¼Ÿ\næ¸…é™¤å¾Œå¯ä»¥é‡æ–°å­¸ç¿’æ‰€æœ‰å–®å­—ï¼Œä½† XP å’Œé€£çºŒå¤©æ•¸æœƒä¿ç•™ã€‚')) {
                userData.learnedHistory = {};
                userData.wordsLearned = [];
                APP_STATE.historyData = [];
                saveUserData();
                updateLearnedWordsList();
                alert('å­¸ç¿’è¨˜éŒ„å·²æ¸…é™¤ï¼');
            }
        }

        // ===== æ‰‹æ©Ÿé¸å–® =====
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
            
            // åŒæ­¥æ›´æ–°æ‰‹æ©Ÿç‰ˆä¸»é¡Œåˆ—è¡¨
            if (!menu.classList.contains('hidden')) {
                updateMobileTopics();
            }
        }

        function updateMobileTopics() {
            updateMobileTopicSelect();
        }

        function updateMobileTopicSelect() {
            const select = document.getElementById('mobile-topic-select');
            if (!select) return;
            
            const topics = TOPICS[APP_STATE.currentMode] || [];
            
            select.innerHTML = topics.map(t => `
                <option value="${t.value}" ${t.value === APP_STATE.currentTopic ? 'selected' : ''}>${t.label}</option>
            `).join('');
        }

        function onMobileTopicChange() {
            const select = document.getElementById('mobile-topic-select');
            APP_STATE.currentTopic = select.value;
            APP_STATE.historyData = [];
            
            // åŒæ­¥æ¡Œé¢ç‰ˆé¸å–®
            const desktopSelect = document.getElementById('topic-select');
            if (desktopSelect) desktopSelect.value = select.value;
            
            toggleMobileMenu();
            loadContent();
        }

        // ===== æ™ºèƒ½èªéŸ³è¼¸å…¥åŠŸèƒ½ï¼ˆè‡ªå‹•åˆ¤æ–·ä¸­è‹±æ–‡ï¼‰=====
        let currentRecognition = null;
        let isListening = false;

        function startSmartVoiceInput(targetInputId) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨');
                return;
            }

            // å¦‚æœæ­£åœ¨è†è½ï¼Œåœæ­¢å®ƒ
            if (isListening && currentRecognition) {
                try {
                    currentRecognition.stop();
                } catch (e) {
                    console.log('åœæ­¢èªéŸ³è­˜åˆ¥:', e);
                }
                cleanupRecognition();
                return;
            }

            // æ¸…ç†èˆŠçš„å¯¦ä¾‹ï¼ˆé‡è¦ï¼šç¢ºä¿æ¯æ¬¡éƒ½æ˜¯æ–°å¯¦ä¾‹ï¼‰
            cleanupRecognition();

            // å‰µå»ºæ–°çš„èªéŸ³è­˜åˆ¥å¯¦ä¾‹ï¼ˆæ¯æ¬¡ä½¿ç”¨éƒ½å‰µå»ºæ–°å¯¦ä¾‹ï¼Œé¿å…é‡è¤‡ä½¿ç”¨å•é¡Œï¼‰
            currentRecognition = new SpeechRecognition();
            
            // è¨­ç½®èªè¨€è­˜åˆ¥ï¼ˆæ ¹æ“šç›®æ¨™è¼¸å…¥æ¡†æ±ºå®šï¼‰
            // æ³¨æ„ï¼šSpeechRecognition API ä¸€æ¬¡åªèƒ½è¨­ç½®ä¸€å€‹èªè¨€
            // å°æ–¼èŠå¤©æ¨¡å¼ï¼Œæˆ‘å€‘ä½¿ç”¨ä¸­æ–‡å„ªå…ˆï¼Œå› ç‚ºç”¨æˆ¶å¯èƒ½èªªä¸­æ–‡è®“ AI æ•™è‹±æ–‡
            // å¦‚æœç”¨æˆ¶èªªè‹±æ–‡ï¼Œè­˜åˆ¥çµæœä¹Ÿæœƒæ˜¯è‹±æ–‡ï¼ˆåªæ˜¯è­˜åˆ¥æº–ç¢ºåº¦å¯èƒ½ç¨ä½ï¼‰
            if (targetInputId === 'chat-input') {
                // èŠå¤©æ¨¡å¼ï¼šä½¿ç”¨ä¸­æ–‡ï¼Œå› ç‚ºç”¨æˆ¶å¯èƒ½èªªä¸­æ–‡è®“ AI æ•™è‹±æ–‡
                // å¦‚æœç”¨æˆ¶èªªè‹±æ–‡ï¼Œè­˜åˆ¥çµæœä¹ŸæœƒåŒ…å«è‹±æ–‡ï¼ˆé›–ç„¶è¨­ç½®ç‚ºä¸­æ–‡ï¼Œä½†è‹±æ–‡ä¹Ÿèƒ½è­˜åˆ¥ï¼‰
                currentRecognition.lang = 'zh-TW';
            } else {
                // å…¶ä»–æ¨¡å¼ï¼ˆå¦‚æ‹¼å¯«ç·´ç¿’ï¼‰ï¼šåªä½¿ç”¨è‹±æ–‡
                currentRecognition.lang = 'en-US';
            }
            
            currentRecognition.continuous = false;
            currentRecognition.interimResults = true;
            currentRecognition.maxAlternatives = 1;

            const targetInput = document.getElementById(targetInputId);
            const statusDiv = targetInputId === 'chat-input' ? document.getElementById('chat-voice-status') : document.getElementById('voice-status');
            const statusText = document.getElementById('voice-status-text');
            const micBtn = document.getElementById(targetInputId === 'chat-input' ? 'chat-mic-btn' : 'typing-mic-btn');

            // é¡¯ç¤ºè†è½ç‹€æ…‹
            if (statusDiv) {
                statusDiv.classList.remove('hidden');
                if (statusText) {
                    statusText.textContent = 'æ­£åœ¨è†è½ï¼Œè«‹èªªè©±...';
                }
                if (statusDiv.querySelector('div')) {
                    statusDiv.querySelector('div').className = 'inline-flex items-center gap-2 bg-purple-500/20 text-purple-400 px-4 py-2 rounded-full text-sm';
                }
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            if (micBtn) {
                micBtn.classList.add('animate-pulse', 'ring-4', 'ring-purple-500/50');
                micBtn.innerHTML = '<i class="fa-solid fa-stop text-lg"></i>';
            }

            currentRecognition.onstart = function() {
                isListening = true;
                console.log('èªéŸ³è­˜åˆ¥å·²é–‹å§‹');
            };

            currentRecognition.onend = function() {
                console.log('èªéŸ³è­˜åˆ¥å·²çµæŸ');
                
                // æ¸…é™¤è¶…æ™‚è¨ˆæ™‚å™¨
                if (currentRecognition._timeoutId) {
                    clearTimeout(currentRecognition._timeoutId);
                    currentRecognition._timeoutId = null;
                }
                
                // å»¶é²æ¸…ç†ï¼Œç¢ºä¿æ‰€æœ‰äº‹ä»¶éƒ½è™•ç†å®Œ
                setTimeout(() => {
                    // åªæœ‰åœ¨æ²’æœ‰æœ€çµ‚çµæœæ™‚æ‰æ¸…ç†ï¼ˆé¿å…åœ¨ onresult è™•ç†æ™‚è¡çªï¼‰
                    if (!isListening || !currentRecognition) {
                        cleanupRecognition();
                    }
                }, 200);
            };

            currentRecognition.onerror = function(event) {
                console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);
                
                // æŸäº›éŒ¯èª¤ä¸éœ€è¦é¡¯ç¤ºæç¤ºï¼ˆå¦‚ no-speechï¼‰
                if (event.error === 'no-speech') {
                    // æ²’æœ‰èªéŸ³ï¼Œéœé»˜çµæŸ
                    if (statusText) {
                        statusText.textContent = 'æœªåµæ¸¬åˆ°èªéŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡';
                        setTimeout(() => {
                            if (statusDiv) statusDiv.classList.add('hidden');
                        }, 2000);
                    }
                    cleanupRecognition();
                    return;
                }
                
                if (event.error === 'not-allowed') {
                    showVoiceError('è«‹å…è¨±ä½¿ç”¨éº¥å…‹é¢¨æ¬Šé™ï¼ˆæª¢æŸ¥ç€è¦½å™¨è¨­å®šï¼‰');
                } else if (event.error === 'aborted') {
                    // ç”¨æˆ¶ä¸»å‹•åœæ­¢ï¼Œä¸éœ€è¦æç¤º
                } else if (event.error === 'network') {
                    showVoiceError('ç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦');
                } else if (event.error === 'audio-capture') {
                    showVoiceError('ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥è£ç½®è¨­å®š');
                } else {
                    showVoiceError('èªéŸ³è­˜åˆ¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                }
                
                cleanupRecognition();
            };

            currentRecognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';
                let detectedLanguage = '';

                // è™•ç†æ‰€æœ‰çµæœ
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result && result[0]) {
                        const transcript = result[0].transcript.trim();
                        if (result.isFinal) {
                            finalTranscript += (finalTranscript ? ' ' : '') + transcript;
                        } else {
                            interimTranscript += (interimTranscript ? ' ' : '') + transcript;
                        }
                    }
                }

                // æª¢æ¸¬èªè¨€ï¼ˆæ ¹æ“šæ–‡å­—å…§å®¹åˆ¤æ–·ï¼‰
                const testText = finalTranscript || interimTranscript;
                if (testText) {
                    const hasChinese = /[\u4e00-\u9fff]/.test(testText);
                    detectedLanguage = hasChinese ? 'zh' : 'en';
                }

                // å³æ™‚é¡¯ç¤ºè¾¨è­˜çµæœï¼ˆè‡¨æ™‚çµæœï¼‰
                if (interimTranscript && targetInput) {
                    targetInput.value = interimTranscript;
                    // æ ¹æ“šæª¢æ¸¬åˆ°çš„èªè¨€è¨­ç½®é¡è‰²
                    if (targetInputId === 'chat-input') {
                        targetInput.style.color = detectedLanguage === 'zh' ? '#fbbf24' : '#94a3b8';
                    }
                    
                    // æ›´æ–°ç‹€æ…‹æç¤ºï¼ˆåƒ…èŠå¤©æ¨¡å¼ï¼‰
                    if (statusText && targetInputId === 'chat-input') {
                        statusText.textContent = detectedLanguage === 'zh' 
                            ? 'åµæ¸¬åˆ°ä¸­æ–‡ï¼ŒAI æœƒæ•™ä½ è‹±æ–‡...' 
                            : 'åµæ¸¬åˆ°è‹±æ–‡ï¼Œç·´ç¿’å°è©±ä¸­...';
                    }
                }

                // è™•ç†æœ€çµ‚çµæœ
                if (finalTranscript && targetInput) {
                    // ç¢ºä¿è¼¸å…¥æ¡†æœ‰å€¼
                    targetInput.value = finalTranscript.trim();
                    
                    // è§¸ç™¼ input äº‹ä»¶ï¼Œç¢ºä¿å…¶ä»–ç›£è½å™¨èƒ½æ”¶åˆ°
                    const inputEvent = new Event('input', { bubbles: true });
                    targetInput.dispatchEvent(inputEvent);
                    
                    // æœ€çµ‚çµæœæ ¹æ“šèªè¨€è¨­ç½®é¡è‰²ï¼ˆåƒ…èŠå¤©æ¨¡å¼ï¼‰
                    if (targetInputId === 'chat-input') {
                        targetInput.style.color = detectedLanguage === 'zh' ? '#fbbf24' : '#ffffff';
                    }
                    
                    // éš±è—è†è½ç‹€æ…‹
                    if (statusDiv) {
                        statusDiv.classList.add('hidden');
                    }
                    
                    // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                    playSound('correct');
                    
                    // å¦‚æœæ˜¯èŠå¤©æ¨¡å¼ä¸”æª¢æ¸¬åˆ°ä¸­æ–‡ï¼Œå¯ä»¥è‡ªå‹•ç™¼é€æˆ–æç¤º
                    if (targetInputId === 'chat-input' && detectedLanguage === 'zh') {
                        // å¯ä»¥é¸æ“‡è‡ªå‹•ç™¼é€æˆ–è®“ç”¨æˆ¶ç¢ºèª
                        // é€™è£¡æˆ‘å€‘ä¸è‡ªå‹•ç™¼é€ï¼Œè®“ç”¨æˆ¶ç¢ºèªå¾Œå†ç™¼é€
                    }
                    
                    // æ¸…ç†å¯¦ä¾‹
                    setTimeout(() => {
                        cleanupRecognition();
                    }, 100);
                }
            };

            try {
                // ç¢ºä¿è¼¸å…¥æ¡†å­˜åœ¨
                if (!targetInput) {
                    console.error('æ‰¾ä¸åˆ°ç›®æ¨™è¼¸å…¥æ¡†:', targetInputId);
                    cleanupRecognition();
                    return;
                }
                
                isListening = true;
                currentRecognition.start();
                
                // è¨­ç½®è¶…æ™‚ä¿è­·ï¼ˆ30ç§’å¾Œè‡ªå‹•åœæ­¢ï¼‰
                const timeoutId = setTimeout(() => {
                    if (isListening) {
                        console.log('èªéŸ³è­˜åˆ¥è¶…æ™‚ï¼Œè‡ªå‹•åœæ­¢');
                        cleanupRecognition();
                        if (statusText) {
                            statusText.textContent = 'è†è½æ™‚é–“éé•·ï¼Œå·²è‡ªå‹•åœæ­¢';
                            setTimeout(() => {
                                if (statusDiv) statusDiv.classList.add('hidden');
                            }, 2000);
                        }
                    }
                }, 30000);
                
                // ä¿å­˜è¶…æ™‚ ID ä»¥ä¾¿æ¸…ç†
                currentRecognition._timeoutId = timeoutId;
                
            } catch (e) {
                console.error('ç„¡æ³•å•Ÿå‹•èªéŸ³è¾¨è­˜:', e);
                cleanupRecognition();
                
                // å¦‚æœéŒ¯èª¤æ˜¯å› ç‚ºå·²ç¶“åœ¨é‹è¡Œï¼Œå…ˆåœæ­¢å†é‡è©¦
                if (e.message && (e.message.includes('already started') || e.message.includes('already running'))) {
                    setTimeout(() => {
                        startSmartVoiceInput(targetInputId);
                    }, 500);
                } else {
                    showVoiceError('ç„¡æ³•å•Ÿå‹•èªéŸ³è­˜åˆ¥ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                }
            }
        }

        // æ¸…ç†èªéŸ³è­˜åˆ¥å¯¦ä¾‹
        function cleanupRecognition() {
            isListening = false;
            
            // åœæ­¢ä¸¦æ¸…ç†å¯¦ä¾‹
            if (currentRecognition) {
                // æ¸…é™¤è¶…æ™‚è¨ˆæ™‚å™¨
                if (currentRecognition._timeoutId) {
                    clearTimeout(currentRecognition._timeoutId);
                    currentRecognition._timeoutId = null;
                }
                
                try {
                    currentRecognition.stop();
                } catch (e) {
                    // å¿½ç•¥åœæ­¢éŒ¯èª¤
                }
                
                // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
                try {
                    currentRecognition.onstart = null;
                    currentRecognition.onend = null;
                    currentRecognition.onerror = null;
                    currentRecognition.onresult = null;
                } catch (e) {
                    // å¿½ç•¥éŒ¯èª¤
                }
                
                currentRecognition = null;
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const chatMicBtn = document.getElementById('chat-mic-btn');
            const typingMicBtn = document.getElementById('typing-mic-btn');
            
            [chatMicBtn, typingMicBtn].forEach(btn => {
                if (!btn) return;
                btn.classList.remove('animate-pulse', 'ring-4', 'ring-purple-500/50');
                btn.innerHTML = '<i class="fa-solid fa-microphone text-lg"></i>';
            });

            // éš±è—æ‰€æœ‰è†è½ç‹€æ…‹
            document.getElementById('chat-voice-status')?.classList.add('hidden');
            document.getElementById('voice-status')?.classList.add('hidden');
        }

        // ä¿ç•™èˆŠçš„ startVoiceInput å‡½æ•¸ä»¥å…¼å®¹ typing æ¨¡å¼
        function startVoiceInput(targetInputId) {
            startSmartVoiceInput(targetInputId);
        }

        function showVoiceError(message) {
            // ç°¡å–®çš„éŒ¯èª¤æç¤º
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-lg z-50 animate-slide';
            toast.innerHTML = `<i class="fa-solid fa-exclamation-circle mr-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // æª¢æŸ¥èªéŸ³è¾¨è­˜æ”¯æ´ï¼ˆä¸éœ€è¦é å…ˆåˆå§‹åŒ–ï¼ŒæŒ‰éœ€å‰µå»ºï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                // éš±è—æ‰€æœ‰éº¥å…‹é¢¨æŒ‰éˆ•
                document.querySelectorAll('[id$="-mic-btn"]').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        });

        function resetAllData() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç¿’æ•¸æ“šå—ï¼Ÿ\né€™æœƒæ¸…é™¤æ‰€æœ‰ XPã€é€£çºŒå¤©æ•¸å’Œå­¸ç¿’è¨˜éŒ„ï¼')) {
                userData = { 
                    xp: 0, 
                    streak: 0, 
                    wordsLearned: [], 
                    learnedHistory: {},
                    totalCorrect: 0, 
                    totalAnswered: 0, 
                    lastActive: null 
                };
                APP_STATE.historyData = [];
                saveUserData();
                closeStats();
                alert('æ‰€æœ‰æ•¸æ“šå·²é‡ç½®ï¼');
            }
        }
    </script>
</body>
</html>
